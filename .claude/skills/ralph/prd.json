{
  "project": "Chatbot Gehalt Pflege",
  "branchName": "ralph/ai-guided-salary-interview-state-machine",
  "description": "AI-Guided Salary Interview with State Machine Integration - Combine conversational AI with state machine guardrails for smooth, guided salary interview",
  "userStories": [
    {
      "id": "US-001",
      "title": "Implement ConversationAnalyzer utility",
      "description": "As a developer, I need a utility to analyze user intent (data vs question vs modification vs confirmation) so the system can respond appropriately.",
      "acceptanceCriteria": [
        "Create ConversationAnalyzer.ts in utils/agent/",
        "Implement analyzeIntent() method that returns 'data' | 'question' | 'modification' | 'confirmation'",
        "Use LLM to classify user message based on current FormState context",
        "Export class for use in route handler",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Implement ResponseValidator utility",
      "description": "As a developer, I need a utility to validate and enrich extracted field values using vectorstore context.",
      "acceptanceCriteria": [
        "Create ResponseValidator.ts in utils/agent/",
        "Implement validate() method that checks field values against expected formats/enums",
        "Implement enrichWithVectorstore() method to normalize values (e.g., 'TVöD' → 'tvoed')",
        "Return validation result with error messages for invalid inputs",
        "Export class for use in route handler",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Enhance FormState type with conversation tracking",
      "description": "As a developer, I need FormState to track conversation context and validation state.",
      "acceptanceCriteria": [
        "Add conversationContext?: string[] field to FormState type in types/form.ts",
        "Add userIntent?: 'data' | 'question' | 'modification' | 'confirmation' field",
        "Add validationErrors?: Record<string, string> field",
        "Update all existing FormState usages to be compatible with new optional fields",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Add state machine helper methods",
      "description": "As a developer, I need helper methods in SalaryStateMachine for completion checking and progress calculation.",
      "acceptanceCriteria": [
        "Add isComplete() method to check if all required fields are collected",
        "Add canTransition(nextState) method for validation before transitions",
        "Add getProgress() method that returns completion percentage: (totalRequired - missing) / totalRequired * 100",
        "Methods work correctly across all states (JOB_DETAILS, TAX_DETAILS, SUMMARY)",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Enhance extraction phase with intent detection",
      "description": "As a developer, I need the extraction phase to detect user intent before extracting data.",
      "acceptanceCriteria": [
        "In route.ts extraction phase, use ConversationAnalyzer to detect intent first",
        "Store detected intent in FormState.userIntent",
        "Only extract data when intent is 'data' or 'modification'",
        "Skip extraction for 'question' intent",
        "Pass intent to response generation phase",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Add validation and enrichment to extraction phase",
      "description": "As a developer, I need extracted values to be validated and enriched before updating FormState.",
      "acceptanceCriteria": [
        "After extraction, use ResponseValidator.validate() on each extracted field",
        "If validation fails, store error in FormState.validationErrors",
        "If validation passes, use ResponseValidator.enrichWithVectorstore() to normalize values",
        "Only update FormState.data with valid, enriched values",
        "Invalid values trigger clarification in response generation",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Enhance response generation with question handling",
      "description": "As a user, I want my questions answered using vectorstore context without affecting the interview flow.",
      "acceptanceCriteria": [
        "When userIntent is 'question', query vectorstore with user message",
        "Include vectorstore answer in system prompt for response generation",
        "After answering question, agent continues with missing fields from systemInstructions",
        "Questions do not trigger state transitions",
        "FormState remains unchanged after question handling",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Implement clarification requests for ambiguous input",
      "description": "As a user, I want to receive clarification requests when my answer is unclear or invalid.",
      "acceptanceCriteria": [
        "When FormState.validationErrors has entries, generate clarification request",
        "Clarification includes specific error message from validator",
        "Clarification suggests examples or valid options when available",
        "State machine does not transition until valid data provided",
        "FormState.data is not updated with invalid values",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Update response prompts to use user-friendly language",
      "description": "As a user, I want to be asked simple questions in everyday language, not technical jargon.",
      "acceptanceCriteria": [
        "Update system prompts to ask about 'job role' not 'Entgeltgruppe'",
        "Prompts use conversational German with examples",
        "Each question focuses on one piece of information",
        "Agent internally maps user-friendly responses to technical field names",
        "Examples provided when questions might be unclear",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Add progress tracking to responses",
      "description": "As a user, I want to see how far along I am in the interview process.",
      "acceptanceCriteria": [
        "Calculate progress using SalaryStateMachine.getProgress() after each data extraction",
        "Include [PROGRESS: N] marker in agent responses where N is percentage",
        "Progress updates correctly as fields are collected",
        "Progress reaches 100% when all required fields collected",
        "Frontend can parse progress marker for UI display",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Implement summary state data display",
      "description": "As a user, I want to review all my answers in the summary phase before calculation.",
      "acceptanceCriteria": [
        "When state is SUMMARY, format all FormState.data in human-readable format",
        "Display job_details section with user-friendly labels",
        "Display tax_details section with user-friendly labels",
        "Summary uses conversational German",
        "Ask for confirmation after displaying summary",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Add modification detection in summary phase",
      "description": "As a user, I want to modify specific answers during the summary phase.",
      "acceptanceCriteria": [
        "When userIntent is 'modification' in SUMMARY state, detect which field to modify",
        "Extract new value for the modified field",
        "Validate and enrich the new value using ResponseValidator",
        "Update FormState.data with the corrected value",
        "Re-display summary with updated values and ask for confirmation again",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Implement confirmation detection in summary phase",
      "description": "As a user, I want the calculation to trigger automatically when I confirm the summary.",
      "acceptanceCriteria": [
        "When userIntent is 'confirmation' in SUMMARY state, proceed to calculation",
        "Detect confirmation phrases: 'ja', 'yes', 'berechnen', 'go', 'stimmt', 'passt'",
        "Set flag to trigger calculate_net_salary tool call",
        "Confirmation only works when FormState is complete and valid",
        "No confirmation = stay in SUMMARY state",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Map FormState to calculate_net_salary tool parameters",
      "description": "As a developer, I need to convert FormState fields to tool parameters for salary calculation.",
      "acceptanceCriteria": [
        "Create mapping function from FormState.data to calculate_net_salary params",
        "Extract yearlySalary from tarif + group + experience + hours",
        "Map taxClass from tax_details.taxClass",
        "Map hasChildren and childCount from tax_details.numberOfChildren",
        "Map churchTax, state, year from FormState",
        "Handle missing or invalid fields with appropriate errors",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Trigger salary calculation on confirmation",
      "description": "As a user, I want my salary calculated automatically after I confirm the summary.",
      "acceptanceCriteria": [
        "When confirmation detected in SUMMARY state, call calculate_net_salary tool",
        "Pass mapped FormState parameters to tool",
        "Receive calculation results (brutto, netto, taxes, etc.)",
        "Handle tool errors gracefully with user-friendly messages",
        "Store raw calculation result in FormState or conversation context",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Format and display calculation results",
      "description": "As a user, I want to see my salary calculation results in a clear, formatted breakdown.",
      "acceptanceCriteria": [
        "Format calculation results with German number formatting (comma for decimals)",
        "Display: Bruttogehalt, Nettogehalt, Steuern, Sozialabgaben",
        "Use clear labels and emoji icons for readability",
        "Include month/year context in display",
        "Results displayed in conversational response",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Save calculation results to database",
      "description": "As a user, I want my calculation saved automatically so I can access it later.",
      "acceptanceCriteria": [
        "After successful calculation, save to salary_inquiries table",
        "Include all FormState.data fields (job_details + tax_details)",
        "Include calculation results (brutto, netto, taxes, etc.)",
        "Include timestamp and projectId",
        "Use existing database save logic from route.ts",
        "Confirm save success to user",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Transition to COMPLETED state after calculation",
      "description": "As a developer, I need the state machine to transition to COMPLETED after successful calculation and save.",
      "acceptanceCriteria": [
        "After saving to database, call SalaryStateMachine.transition('COMPLETED')",
        "COMPLETED state prevents further data collection",
        "Agent acknowledges completion in response",
        "FormState reflects COMPLETED state",
        "Further messages handled gracefully (e.g., 'calculation already complete')",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Add conversation context tracking",
      "description": "As a developer, I need to maintain conversation history for multi-turn context.",
      "acceptanceCriteria": [
        "Store last 5-10 user messages in FormState.conversationContext",
        "Include conversationContext in LLM prompts for extraction and response",
        "Context helps with ambiguous references (e.g., 'change that to 35 hours')",
        "Context array is circular buffer (oldest removed when full)",
        "Context persists across turns via FormState from frontend",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Implement vectorstore caching for frequent queries",
      "description": "As a developer, I need to cache frequent vectorstore queries to improve performance.",
      "acceptanceCriteria": [
        "Add in-memory cache for vectorstore query results",
        "Cache TTL: 24 hours",
        "Cache key: normalized question string",
        "Common queries cached: 'TVöD', 'TV-L', 'Steuerklasse', 'Kirchensteuer'",
        "Cache miss falls back to vectorstore query",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "End-to-end testing of complete interview flow",
      "description": "As a developer, I need to verify the entire flow works from start to calculation.",
      "acceptanceCriteria": [
        "Test complete flow: greeting → job details → tax details → summary → calculation",
        "Test question handling mid-interview without breaking flow",
        "Test ambiguous input triggering clarification",
        "Test answer modification in summary phase",
        "Test confirmation detection and calculation trigger",
        "Verify database save and COMPLETED state transition",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    }
  ]
}
