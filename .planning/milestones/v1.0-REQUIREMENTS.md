# Requirements Archive: v1.0 Document Pipeline

**Archived:** 2026-01-25
**Status:** SHIPPED

This is the archived requirements specification for v1.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: Gehalt-Pflege Document Pipeline

**Defined:** 2026-01-23
**Core Value:** Documents uploaded by admins must reliably become searchable context for the chatbot

## v1 Requirements

Requirements for the document pipeline milestone. Each maps to roadmap phases.

### File Operations

- [x] **FILE-01**: Admin can upload documents (PDF, text, spreadsheets) with size/type validation
- [x] **FILE-02**: Admin can delete document atomically (storage file + DB record + chunks removed together)
- [x] **FILE-03**: Admin can download document via time-limited signed URL

### Status Tracking

- [x] **STAT-01**: Document status reflects pipeline state: pending -> processing -> embedded / error
- [x] **STAT-02**: Failed documents store error message explaining what went wrong
- [x] **STAT-03**: Admin UI displays document status with visual indicators

### Error Recovery

- [x] **ERR-01**: Admin can reprocess failed documents (reset to pending, re-trigger pipeline)
- [x] **ERR-02**: Upload failure rolls back: if DB insert fails, storage file is deleted
- [x] **ERR-03**: Delete failure is atomic: storage and DB deletion succeed together or both fail

### Edge Function Processing

- [x] **EDGE-01**: Edge function parses embedding API response defensively (handles structure variations)
- [x] **EDGE-02**: Batch embedding uses Promise.allSettled for partial failure tolerance
- [x] **EDGE-03**: Gemini uploaded files are cleaned up in finally block (even on error)
- [x] **EDGE-04**: Chunks are inserted into document_chunks table with correct embeddings

### Database Integrity

- [x] **DB-01**: Deleting a document cascades to delete all associated chunks
- [x] **DB-02**: RLS policies allow service role to insert into document_chunks
- [x] **DB-03**: Documents table has error_details JSONB column for storing failure details

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| DB-01 | Phase 1 | Complete |
| DB-02 | Phase 1 | Complete |
| DB-03 | Phase 1 | Complete |
| FILE-01 | Phase 2 | Complete |
| FILE-02 | Phase 2 | Complete |
| FILE-03 | Phase 2 | Complete |
| ERR-02 | Phase 2 | Complete |
| ERR-03 | Phase 2 | Complete |
| STAT-01 | Phase 3 | Complete |
| STAT-02 | Phase 3 | Complete |
| STAT-03 | Phase 3 | Complete |
| EDGE-01 | Phase 4 | Complete |
| EDGE-02 | Phase 4 | Complete |
| EDGE-03 | Phase 4 | Complete |
| EDGE-04 | Phase 4 | Complete |
| ERR-01 | Phase 5 | Complete |

**Coverage:**
- v1 requirements: 16 total
- Mapped to phases: 16/16
- Unmapped: 0

---

## Milestone Summary

**Shipped:** 16 of 16 v1 requirements
**Adjusted:** None - all requirements delivered as specified
**Dropped:** None

---
*Archived: 2026-01-25 as part of v1.0 milestone completion*
