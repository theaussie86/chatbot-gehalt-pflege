# Milestone v1.1: Chat Intelligence

**Status:** SHIPPED 2026-02-03
**Phases:** 7-11
**Total Plans:** 11

## Overview

The v1.1 Chat Intelligence milestone transforms the chatbot from a stateless interview into an intelligent conversational partner. Users gain conversation persistence across sessions, AI-powered suggested responses reduce typing friction, enhanced function calling enables structured tool interactions, validation improvements ensure data quality, and citation quality adds trustworthy source references for admin traceability.

## Phases

### Phase 7: Conversation Persistence

**Goal:** Users can resume conversations across sessions, admins gain visibility into inquiry data
**Depends on:** Phase 6 (RAG Integration)
**Plans:** 3 plans

Plans:
- [x] 07-01: Client-side conversation persistence and step progress indicator
- [x] 07-02: Admin inquiry dashboard with structured data and filters
- [x] 07-03: Email export with DOI consent and formatted result email

**Requirements covered:** CONV-01, CONV-02, CONV-03, CONV-04, CONV-05, CONV-06

**Details:**
- localStorage-based conversation storage with auto-resume
- StepBar visual progress indicator showing collected fields
- Admin dashboard with expandable table rows for inquiry details
- Email export via Resend with inline DOI consent form
- Inquiry ID flow for precise single-row DB updates

### Phase 8: Function Calling Enhancement

**Goal:** AI reliably executes tax calculations and tariff lookups via structured tool calls
**Depends on:** Phase 6 (RAG Integration)
**Plans:** 2 plans

Plans:
- [x] 08-01: Zod tool schema foundation (single source of truth for validation and Gemini tools)
- [x] 08-02: Tool implementation with tariff lookup, tax calculation, and retry orchestration

**Requirements covered:** FUNC-01, FUNC-02, FUNC-03, FUNC-04, FUNC-05

**Details:**
- Zod schemas as single source of truth for tool validation AND Gemini function declarations
- Real salary tables for TVöD, TV-L, AVR (P5-P15, E5-E15 groups)
- ToolExecutor with Zod validation and session-based retry tracking (max 3 attempts)
- Two-step workflow: tariff lookup → tax calculation

### Phase 9: Suggested Response Chips

**Goal:** Users tap quick reply options instead of typing on mobile
**Depends on:** Phase 7 (Conversation Persistence)
**Plans:** 2 plans

Plans:
- [x] 09-01: Backend suggestion generation based on formState stage
- [x] 09-02: SuggestionChips component with tap-to-fill behavior

**Requirements covered:** CHIP-01, CHIP-02, CHIP-03, CHIP-04, CHIP-05

**Details:**
- Hybrid suggestion approach: predefined chips for known fields, AI-generated for open questions
- 44x44px minimum tap targets for mobile accessibility compliance
- FLIP animation technique for smooth chip-to-bubble transition (300ms ease-out)
- Fade to 40% opacity when typing (not hide) to maintain discoverability

### Phase 10: Validation Improvements

**Goal:** Data extraction is reliable with user-friendly German error messages
**Depends on:** Phase 8 (Function Calling Enhancement)
**Plans:** 2 plans

Plans:
- [x] 10-01: Zod form field schemas with German pre-processors and friendly error messages
- [x] 10-02: Chat route integration with two-phase validation and escalation chips

**Requirements covered:** VALD-01, VALD-02, VALD-05

**Details:**
- Two-phase validation: LLM extracts → Zod schema validates
- German number word pre-processing (eins, zwei, drei → 1, 2, 3)
- FieldValidator service with 30-min TTL for retry context
- Escalation chips after 3 validation failures with German field labels

### Phase 11: Citation Quality Enhancement

**Goal:** Admin sees document name and page numbers for RAG-sourced answers
**Depends on:** Phase 6 (RAG Integration)
**Plans:** 2 plans

Plans:
- [x] 11-01: Schema and processing pipeline for page number extraction
- [x] 11-02: Chat API citation storage and admin UI display

**Requirements covered:** VALD-03, VALD-04

**Details:**
- [PAGE:N] markers in Gemini extraction prompt for page tracking
- page_start/page_end columns in document_chunks table
- Citations stored in salary_inquiries.details, displayed in admin inquiry detail
- User-facing responses clean of citations (admin-only traceability)

---

## Milestone Summary

**Key Decisions:**
- localStorage over Dexie.js for conversation persistence (simpler for <100 messages)
- Zod schemas as single source of truth for tool validation AND Gemini function declarations
- Hybrid suggestion approach: predefined chips for known fields, AI-generated for open questions
- Two-phase validation flow: LLM extraction → Zod validation → German error re-prompts
- Admin-only citations pattern: store for traceability, hide from user responses

**Issues Resolved:**
- P0-2: Function calling schema drift (single source of truth with Zod)
- P0-3: RAG citation hallucination (store page metadata, don't generate)
- P1-1: Suggested response overload (max 4 chips, skip for freeform fields)
- P1-3: Data extraction reliability (two-phase validation with FieldValidator)

**Issues Deferred:**
- Multi-device sync via server-side storage (tracked as CONV-07 for v1.2)
- Conversation summarization for long sessions (tracked as CONV-08 for v1.2)

**Technical Debt Incurred:**
- None — all phases completed without deferred items

---

_For current project status, see .planning/ROADMAP.md_
