---
phase: 02-atomic-file-operations
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can upload a PDF and see it in the documents list"
    - "Upload interrupted after storage write leaves no orphaned file"
    - "User can delete a document and verify both storage and DB are removed"
    - "User can download via time-limited signed URL"
    - "Delete interrupted leaves consistent state"
  artifacts: []
  key_links: []
---

<objective>
Verify all Phase 2 file operations work correctly through manual testing.

Purpose: Confirm requirements FILE-01, FILE-02, FILE-03, ERR-02, ERR-03 are complete before proceeding to Phase 3.

Output: Verified file operations with documented test results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-atomic-file-operations/02-01-SUMMARY.md
@.planning/phases/02-atomic-file-operations/02-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify complete file operations workflow</name>
  <what-built>
Plans 01 and 02 implemented:
- Drag-drop upload zone with batch support
- File validation (size/type)
- Rollback visibility with error codes
- Atomic delete (DB-first pattern)
- 5-minute signed URLs for download
- Enhanced UI (document name click vs download icon)
  </what-built>
  <how-to-verify>
**Setup:**
1. Run `npm run dev:api` in terminal
2. Navigate to http://localhost:3000/documents
3. Have Supabase dashboard open for storage/database verification

**Test 1: Upload validation (FILE-01)**
- [ ] Drag a PDF file onto the drop zone - should upload successfully
- [ ] Drag a .txt file - should upload (text/plain is allowed)
- [ ] Drag a .exe or .zip file - should show ERR_INVALID_TYPE error
- [ ] Create 60MB file: `dd if=/dev/zero of=/tmp/large.pdf bs=1M count=60`
- [ ] Drag large.pdf - should show ERR_SIZE_LIMIT error

**Test 2: Batch upload with progress**
- [ ] Select 3 small PDF files via file picker
- [ ] Verify progress shows "Uploading 1 of 3", "2 of 3", "3 of 3"
- [ ] All 3 appear in document list after completion

**Test 3: Rollback visibility (ERR-02)**
- [ ] Note: Simulating DB failure requires code modification
- [ ] If testable: Verify toast shows "Upload failed. Cleaning up..." then "File removed."
- [ ] Verify retry button appears in error toast

**Test 4: Download and view (FILE-03)**
- [ ] Click document name - PDF opens in new tab
- [ ] Click download icon - file downloads with original filename
- [ ] Verify URL in network tab expires after 5 minutes (can adjust to 10s for testing)

**Test 5: Atomic delete (FILE-02, ERR-03)**
- [ ] Upload a test document
- [ ] In Supabase: Note document ID and storage_path
- [ ] Click delete - modal shows document name and mentions embeddings
- [ ] Confirm delete
- [ ] Verify in Supabase DB: document row deleted
- [ ] Verify in Supabase Storage: file removed from bucket

**Test 6: Consistency check**
- [ ] Upload a document
- [ ] In Supabase dashboard, manually delete ONLY the storage file
- [ ] Try to download via app - should show error (not crash)
- [ ] Delete document via app - should succeed (cleans up DB record)
  </how-to-verify>
  <resume-signal>
Type "verified" if all tests pass, or describe any failures:
- Which test failed?
- What was the expected vs actual behavior?
- Any error messages in console?
  </resume-signal>
</task>

</tasks>

<verification>
All 6 test scenarios pass.
</verification>

<success_criteria>
All Phase 2 requirements verified:
- FILE-01: Upload validation works
- FILE-02: Atomic delete works
- FILE-03: Download with signed URLs works
- ERR-02: Rollback visible to user
- ERR-03: Delete atomicity maintained
</success_criteria>

<output>
After verification, create `.planning/phases/02-atomic-file-operations/02-03-SUMMARY.md` with test results.
</output>
