---
phase: 02-atomic-file-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/utils/documents.ts
  - apps/api/app/actions/documents.ts
  - apps/api/components/DocumentManager.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can drag files onto upload zone"
    - "Admin can select multiple files via file picker"
    - "Admin sees batch progress indicator during upload"
    - "Upload validates file type and size server-side"
    - "Admin sees rollback message when upload fails after storage write"
    - "Failed upload toast includes retry button"
  artifacts:
    - path: "apps/api/utils/documents.ts"
      provides: "Upload service with validation and rollback visibility"
      contains: "ERR_SIZE_LIMIT"
    - path: "apps/api/components/DocumentManager.tsx"
      provides: "Drag-drop upload zone with batch progress"
      contains: "onDragOver"
  key_links:
    - from: "apps/api/components/DocumentManager.tsx"
      to: "apps/api/app/actions/documents.ts"
      via: "uploadDocumentAction call"
      pattern: "uploadDocumentAction"
    - from: "apps/api/app/actions/documents.ts"
      to: "apps/api/utils/documents.ts"
      via: "uploadDocumentService call"
      pattern: "uploadDocumentService"
---

<objective>
Enhance upload service with drag-drop UI, batch upload support, file validation, and visible rollback feedback.

Purpose: Deliver FILE-01 (validation) and ERR-02 (rollback visibility) requirements. The current upload is a basic file input with no validation or user feedback on failures.

Output: Enhanced DocumentManager with drag-drop zone, batch progress indicator, and toast notifications showing rollback process when uploads fail.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-atomic-file-operations/02-CONTEXT.md

@apps/api/utils/documents.ts
@apps/api/app/actions/documents.ts
@apps/api/components/DocumentManager.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance upload service with validation and error codes</name>
  <files>apps/api/utils/documents.ts, apps/api/app/actions/documents.ts</files>
  <action>
Update uploadDocumentService in apps/api/utils/documents.ts:

1. Add file validation at the start of the function:
   - Size limit: 50MB (52428800 bytes) - reject with error code ERR_SIZE_LIMIT
   - Allowed MIME types: application/pdf, text/plain, text/csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet (xlsx), application/vnd.ms-excel (xls)
   - Reject invalid types with error code ERR_INVALID_TYPE

2. Create a custom error class DocumentUploadError that includes:
   - code: string (e.g., ERR_SIZE_LIMIT, ERR_INVALID_TYPE, ERR_STORAGE, ERR_DATABASE)
   - message: string (human-readable)
   - rollbackPerformed: boolean (for UI feedback)

3. Modify the rollback section (lines 43-47) to:
   - Wrap storage cleanup in try/catch
   - Throw DocumentUploadError with rollbackPerformed: true after cleanup
   - Log rollback attempt and result

4. Update uploadDocumentAction in apps/api/app/actions/documents.ts:
   - Return structured error: { error: string, code: string, rolledBack?: boolean }
   - Handle DocumentUploadError to extract code and rollback status

Do NOT modify any other behavior. Keep storage-first, DB-second pattern.
  </action>
  <verify>
Create a test file in /tmp with 60MB size:
`dd if=/dev/zero of=/tmp/test-large.pdf bs=1M count=60`
Attempt upload via server action (in test) and verify ERR_SIZE_LIMIT is returned.
  </verify>
  <done>
- Uploads over 50MB rejected with ERR_SIZE_LIMIT code
- Invalid MIME types rejected with ERR_INVALID_TYPE code
- Failed DB inserts trigger storage rollback and return rolledBack: true
  </done>
</task>

<task type="auto">
  <name>Task 2: Add drag-drop upload zone with batch support and progress</name>
  <files>apps/api/components/DocumentManager.tsx</files>
  <action>
Replace the current upload form in DocumentManager.tsx with a drag-drop zone:

1. Create a drop zone container:
   - Full-width box with dashed border
   - onDragOver, onDragLeave, onDrop handlers
   - Visual feedback: border color change on drag hover
   - Click anywhere to trigger hidden file input

2. Support multiple file selection:
   - File input: multiple attribute
   - Process files in sequence (not parallel - for predictable progress)
   - Track: totalFiles, completedFiles, currentFileName

3. Add batch progress indicator:
   - Show during upload: "Uploading 2 of 5: filename.pdf"
   - Progress bar showing completed/total ratio
   - Hide when not uploading

4. Update handleUpload to process multiple files:
   ```typescript
   const files = Array.from(formData.getAll('file') as File[]);
   let completed = 0;
   for (const file of files) {
     setCurrentFileName(file.name);
     setCompletedFiles(completed);
     setTotalFiles(files.length);
     const singleFormData = new FormData();
     singleFormData.append('file', file);
     if (projectId) singleFormData.append('projectId', projectId);
     const result = await uploadDocumentAction(singleFormData);
     if (result.error) {
       // Handle error for this file, continue with others
     }
     completed++;
   }
   ```

5. Style the drop zone with Tailwind:
   - Default: border-2 border-dashed border-gray-300 rounded-lg p-8
   - Drag active: border-blue-500 bg-blue-50
   - Uploading: border-blue-500 with progress bar overlay

Keep the existing file input as a hidden element triggered by drop zone click.
  </action>
  <verify>
Run `npm run dev:api` and navigate to /documents. Verify:
- Drag a file over the zone shows blue border
- Clicking the zone opens file picker
- Selecting multiple files shows progress "Uploading X of Y"
  </verify>
  <done>
- Drop zone visible with click-to-browse and drag-drop support
- Multiple files can be selected
- Progress indicator shows during batch upload
  </done>
</task>

<task type="auto">
  <name>Task 3: Add rollback visibility and retry button to error toasts</name>
  <files>apps/api/components/DocumentManager.tsx</files>
  <action>
Enhance error handling in DocumentManager.tsx:

1. Update error toast to show rollback process:
   ```typescript
   if (result.error) {
     const toastId = toast.loading('Upload failed. Cleaning up...');
     // Simulate brief delay to show cleanup message (rollback already happened server-side)
     setTimeout(() => {
       if (result.rolledBack) {
         toast.error(
           `Upload failed: ${result.error} (${result.code}). File removed.`,
           {
             id: toastId,
             action: {
               label: 'Retry',
               onClick: () => retryUpload(file)
             },
             duration: 10000
           }
         );
       } else {
         toast.error(`Upload failed: ${result.error} (${result.code})`, {
           id: toastId,
           action: {
             label: 'Retry',
             onClick: () => retryUpload(file)
           },
           duration: 10000
         });
       }
     }, 500);
   }
   ```

2. Create retryUpload function:
   - Accepts File object
   - Creates FormData and calls uploadDocumentAction
   - Same error handling as initial upload

3. Track failed files for retry:
   - State: failedFiles: File[]
   - Add to array on failure
   - Remove from array on successful retry or dismiss

4. Show failed files summary if any:
   - "3 files failed to upload. [Retry All]"
   - Retry All button calls retryUpload for each failed file

Use sonner's action prop for the retry button in toasts.
  </action>
  <verify>
Simulate a failure by temporarily modifying uploadDocumentService to throw an error.
Verify:
- Toast shows "Upload failed. Cleaning up..."
- After 500ms updates to show error with code and "File removed"
- Retry button is visible and functional
  </verify>
  <done>
- Failed uploads show "Cleaning up..." then "File removed" in toast
- Error messages include error code (e.g., ERR_SIZE_LIMIT)
- Retry button appears in error toast
- Failed files can be retried individually or all at once
  </done>
</task>

</tasks>

<verification>
1. Upload validation works:
   - Create oversized file (60MB), attempt upload, verify ERR_SIZE_LIMIT
   - Rename a .txt file to .exe, attempt upload, verify ERR_INVALID_TYPE

2. Drag-drop and batch:
   - Drag 3 PDFs onto zone, verify progress indicator
   - Click zone, select multiple files, verify batch upload

3. Rollback visibility:
   - Simulate DB failure (disconnect network after storage write)
   - Verify toast shows cleanup message
   - Verify storage file was removed (check Supabase dashboard)
</verification>

<success_criteria>
- FILE-01 complete: File type and size validation implemented
- ERR-02 complete: Upload failure shows rollback process to admin
- Drag-drop zone visible and functional
- Batch upload with progress indicator
- Error toasts include error codes and retry buttons
</success_criteria>

<output>
After completion, create `.planning/phases/02-atomic-file-operations/02-01-SUMMARY.md`
</output>
