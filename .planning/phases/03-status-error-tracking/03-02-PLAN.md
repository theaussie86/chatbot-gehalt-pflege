---
phase: 03-status-error-tracking
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/api/components/DocumentManager.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a document row opens a details side panel"
    - "Side panel shows document metadata (filename, size, upload date, status)"
    - "Error documents show error_details in the panel"
    - "Document status updates in real-time without page refresh"
    - "Toast appears when document status changes"
  artifacts:
    - path: "apps/api/components/DocumentManager.tsx"
      provides: "Document details panel and realtime subscription"
      contains: "DocumentDetailsPanel|useEffect.*supabase.*subscribe"
  key_links:
    - from: "document row onClick"
      to: "Sheet open state"
      via: "setSelectedDocument"
      pattern: "onClick.*setSelectedDocument"
    - from: "Supabase realtime"
      to: "documents state"
      via: "channel subscription"
      pattern: "channel.*documents.*subscribe"
---

<objective>
Add document details side panel and real-time status updates via Supabase realtime.

Purpose: Enable admins to view document metadata and error details without leaving the page, and see status changes as they happen.

Output: DocumentManager with slide-out details panel and live status updates via Supabase realtime subscription.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-status-error-tracking/03-CONTEXT.md
@.planning/phases/03-status-error-tracking/03-01-SUMMARY.md
@apps/api/components/DocumentManager.tsx
@apps/api/components/ui/sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add document details side panel</name>
  <files>apps/api/components/DocumentManager.tsx</files>
  <action>
    Implement a slide-out panel that shows document details when a row is clicked.

    1. Import Sheet components:
       ```typescript
       import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from "@/components/ui/sheet";
       ```

    2. Add state for selected document:
       ```typescript
       const [selectedDocument, setSelectedDocument] = useState<Document | null>(null);
       ```

    3. Update Document interface to include error_details:
       ```typescript
       interface Document {
         id: string;
         filename: string;
         mime_type: string;
         created_at: string;
         project_id?: string | null;
         storage_path?: string;
         status: 'pending' | 'processing' | 'embedded' | 'error';
         error_details?: {
           code?: string;
           message?: string;
           timestamp?: string;
           stage?: string;
           details?: any;
         } | null;
       }
       ```

    4. Create DocumentDetailsPanel component (inline):
       - Receives selectedDocument as prop
       - Displays:
         - Filename (large, bold)
         - Status badge (using StatusBadge component)
         - Upload date (formatted: "January 24, 2026 at 3:45 PM")
         - MIME type
         - Project association (project ID or "Global")
       - For error status, add "Error Details" section:
         - Error message (in a red-tinted box)
         - Error code (if present)
         - Timestamp (if present)
         - Stage that failed (if present)
       - Include "Download" and "Delete" action buttons at bottom

    5. Make document row clickable to open panel:
       - Add onClick to `<li>` element: `onClick={() => setSelectedDocument(doc)}`
       - Add `cursor-pointer` class to `<li>`
       - Keep existing action buttons functional (stop propagation)

    6. Add Sheet component at bottom of DocumentManager:
       ```tsx
       <Sheet open={!!selectedDocument} onOpenChange={(open) => !open && setSelectedDocument(null)}>
         <SheetContent className="w-[400px] sm:w-[540px]">
           <SheetHeader>
             <SheetTitle>Document Details</SheetTitle>
             <SheetDescription>View document information and status</SheetDescription>
           </SheetHeader>
           {selectedDocument && <DocumentDetailsPanel document={selectedDocument} />}
         </SheetContent>
       </Sheet>
       ```

    7. Add stopPropagation to action buttons (download, reprocess, delete) so they don't trigger panel:
       ```typescript
       onClick={(e) => { e.stopPropagation(); handleDownload(doc); }}
       ```
  </action>
  <verify>
    Run dev server and verify:
    - Clicking a document row opens the side panel
    - Panel shows document metadata correctly
    - Error documents display error_details section
    - Action buttons in row still work without opening panel
    - Panel closes when clicking outside or pressing Escape
  </verify>
  <done>Side panel opens on row click, displays all document metadata, error section visible for error status</done>
</task>

<task type="auto">
  <name>Task 2: Add Supabase realtime subscription for status updates</name>
  <files>apps/api/components/DocumentManager.tsx</files>
  <action>
    Implement real-time status updates using Supabase realtime subscription.

    1. Convert component to use local documents state:
       ```typescript
       const [localDocuments, setLocalDocuments] = useState<Document[]>(documents);
       ```

    2. Sync localDocuments when props change:
       ```typescript
       useEffect(() => {
         setLocalDocuments(documents);
       }, [documents]);
       ```

    3. Set up Supabase realtime subscription in useEffect:
       ```typescript
       useEffect(() => {
         const supabase = createClient();

         const channel = supabase
           .channel('documents-changes')
           .on(
             'postgres_changes',
             {
               event: 'UPDATE',
               schema: 'public',
               table: 'documents'
             },
             (payload) => {
               const updated = payload.new as Document;

               // Update local state
               setLocalDocuments(prev =>
                 prev.map(doc => doc.id === updated.id ? { ...doc, ...updated } : doc)
               );

               // Update selected document if it's the one that changed
               setSelectedDocument(prev =>
                 prev?.id === updated.id ? { ...prev, ...updated } : prev
               );

               // Show toast notification for status changes
               if (updated.status === 'embedded') {
                 toast.success(`"${updated.filename}" processing complete`);
               } else if (updated.status === 'error') {
                 toast.error(`"${updated.filename}" processing failed`);
               } else if (updated.status === 'processing') {
                 toast.info(`"${updated.filename}" is now processing`);
               }
             }
           )
           .on(
             'postgres_changes',
             {
               event: 'DELETE',
               schema: 'public',
               table: 'documents'
             },
             (payload) => {
               const deleted = payload.old as { id: string };
               setLocalDocuments(prev => prev.filter(doc => doc.id !== deleted.id));
               // Close panel if deleted document was selected
               setSelectedDocument(prev => prev?.id === deleted.id ? null : prev);
             }
           )
           .on(
             'postgres_changes',
             {
               event: 'INSERT',
               schema: 'public',
               table: 'documents'
             },
             (payload) => {
               const newDoc = payload.new as Document;
               // Prepend new document to list
               setLocalDocuments(prev => [newDoc, ...prev]);
               toast.info(`New document: "${newDoc.filename}"`);
             }
           )
           .subscribe();

         return () => {
           supabase.removeChannel(channel);
         };
       }, []);
       ```

    4. Update all references from `documents` to `localDocuments`:
       - filteredDocuments computation
       - statusCounts computation
       - documents.length checks

    5. Add fade transition classes for status changes (CSS transition):
       ```typescript
       // In the document list item
       <li key={doc.id} className="... transition-colors duration-300">
       ```
  </action>
  <verify>
    Run dev server and verify:
    - Open the documents page in two browser tabs
    - In one tab, simulate a status change (via SQL or edge function trigger)
    - Verify the other tab updates without refresh
    - Verify toast notification appears on status change
    - Verify newly uploaded documents appear at top
    - Verify deleted documents disappear
  </verify>
  <done>Documents update in real-time; toast notifications appear; INSERT/UPDATE/DELETE all handled</done>
</task>

</tasks>

<verification>
1. Run `npm run dev:api` and navigate to /documents
2. Click a document row - side panel should open
3. Verify panel shows filename, status, upload date, MIME type
4. For error documents, verify error_details section appears
5. Verify action buttons work without opening panel
6. Open page in two browser tabs
7. Trigger a status change (upload new doc or simulate via SQL)
8. Verify both tabs update, toast appears
9. Verify panel updates if selected document changes
</verification>

<success_criteria>
- Side panel opens on document row click
- Panel displays all document metadata
- Error documents show error_details section
- Action buttons work without triggering panel
- Real-time updates work across browser tabs
- Toast notifications appear on status changes
- Newly uploaded documents prepend to list
</success_criteria>

<output>
After completion, create `.planning/phases/03-status-error-tracking/03-02-SUMMARY.md`
</output>
