---
phase: 03-status-error-tracking
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - apps/api/components/DocumentManager.tsx
  - apps/api/app/actions/documents.ts
autonomous: false

must_haves:
  truths:
    - "Documents can be selected via checkbox"
    - "Bulk delete button appears when documents selected"
    - "Bulk delete removes all selected documents atomically"
    - "Selection persists through filtering"
    - "Admin can verify complete status tracking workflow"
  artifacts:
    - path: "apps/api/components/DocumentManager.tsx"
      provides: "Checkbox selection and bulk actions"
      contains: "selectedDocuments|bulkDelete"
    - path: "apps/api/app/actions/documents.ts"
      provides: "Bulk delete server action"
      exports: ["bulkDeleteDocumentsAction"]
  key_links:
    - from: "checkbox onChange"
      to: "selectedDocuments state"
      via: "toggle function"
      pattern: "toggleSelection|setSelectedDocuments"
    - from: "bulk delete button"
      to: "bulkDeleteDocumentsAction"
      via: "onClick handler"
      pattern: "handleBulkDelete"
---

<objective>
Add checkbox selection for documents with bulk delete functionality, then human verification of complete workflow.

Purpose: Enable admins to efficiently manage multiple documents at once and verify the complete status tracking implementation.

Output: DocumentManager with checkbox selection, bulk actions toolbar, and verified end-to-end status tracking.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-status-error-tracking/03-CONTEXT.md
@.planning/phases/03-status-error-tracking/03-02-SUMMARY.md
@apps/api/components/DocumentManager.tsx
@apps/api/app/actions/documents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add checkbox selection state and UI</name>
  <files>apps/api/components/DocumentManager.tsx</files>
  <action>
    Implement checkbox selection for documents with select all functionality.

    1. Add selection state:
       ```typescript
       const [selectedDocuments, setSelectedDocuments] = useState<Set<string>>(new Set());
       ```

    2. Create selection helpers:
       ```typescript
       const toggleSelection = (docId: string) => {
         setSelectedDocuments(prev => {
           const next = new Set(prev);
           if (next.has(docId)) {
             next.delete(docId);
           } else {
             next.add(docId);
           }
           return next;
         });
       };

       const toggleSelectAll = () => {
         if (selectedDocuments.size === filteredDocuments.length) {
           setSelectedDocuments(new Set());
         } else {
           setSelectedDocuments(new Set(filteredDocuments.map(d => d.id)));
         }
       };

       const isAllSelected = filteredDocuments.length > 0 &&
         selectedDocuments.size === filteredDocuments.length;
       const isSomeSelected = selectedDocuments.size > 0;
       ```

    3. Add checkbox to document list header (above document items):
       ```tsx
       <div className="flex items-center gap-2 py-2 border-b border-gray-200 dark:border-gray-700">
         <input
           type="checkbox"
           checked={isAllSelected}
           ref={(el) => {
             if (el) el.indeterminate = isSomeSelected && !isAllSelected;
           }}
           onChange={toggleSelectAll}
           className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
         />
         <span className="text-sm text-gray-600 dark:text-gray-400">
           {selectedDocuments.size > 0
             ? `${selectedDocuments.size} selected`
             : `${filteredDocuments.length} documents`}
         </span>
       </div>
       ```

    4. Add checkbox to each document row:
       ```tsx
       <li key={doc.id} className="py-3 flex items-center gap-3 group cursor-pointer">
         <input
           type="checkbox"
           checked={selectedDocuments.has(doc.id)}
           onChange={(e) => {
             e.stopPropagation();
             toggleSelection(doc.id);
           }}
           onClick={(e) => e.stopPropagation()}
           className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
         />
         {/* ... rest of document row content */}
       </li>
       ```

    5. Clear selection when filter changes (optional but good UX):
       ```typescript
       // In filter chip handler, optionally clear selection
       // Or keep selection to allow cross-filter operations
       ```
  </action>
  <verify>
    Run dev server and verify:
    - Checkboxes appear on each document row
    - Select all checkbox appears in header
    - Clicking checkbox selects document (doesn't open panel)
    - Select all works correctly
    - Indeterminate state shows when some but not all selected
    - Selected count displays accurately
  </verify>
  <done>Checkbox selection working with select all, indeterminate state, and count display</done>
</task>

<task type="auto">
  <name>Task 2: Add bulk delete action and toolbar</name>
  <files>apps/api/components/DocumentManager.tsx, apps/api/app/actions/documents.ts</files>
  <action>
    Implement bulk delete server action and UI toolbar.

    1. Add bulkDeleteDocumentsAction to apps/api/app/actions/documents.ts:
       ```typescript
       export async function bulkDeleteDocumentsAction(documentIds: string[]) {
         const supabase = await createClient();

         const results: { id: string; success: boolean; error?: string }[] = [];

         // Delete sequentially for atomicity per document
         for (const id of documentIds) {
           try {
             // Get document first to find storage path
             const { data: doc } = await supabase
               .from('documents')
               .select('storage_path')
               .eq('id', id)
               .single();

             if (!doc) {
               results.push({ id, success: false, error: 'Document not found' });
               continue;
             }

             // DB-first delete (cascade removes chunks)
             const { error: dbError } = await supabase
               .from('documents')
               .delete()
               .eq('id', id);

             if (dbError) {
               results.push({ id, success: false, error: dbError.message });
               continue;
             }

             // Then delete from storage (orphaned file if this fails is acceptable)
             if (doc.storage_path) {
               const { error: storageError } = await supabase.storage
                 .from('project-files')
                 .remove([doc.storage_path]);

               if (storageError) {
                 console.warn(`Storage cleanup failed for ${id}: ${storageError.message}`);
               }
             }

             results.push({ id, success: true });
           } catch (err: any) {
             results.push({ id, success: false, error: err.message });
           }
         }

         const successCount = results.filter(r => r.success).length;
         const failCount = results.filter(r => !r.success).length;

         return {
           success: failCount === 0,
           successCount,
           failCount,
           results
         };
       }
       ```

    2. Add bulk actions toolbar in DocumentManager.tsx (appears when documents selected):
       ```tsx
       {selectedDocuments.size > 0 && (
         <div className="flex items-center justify-between bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-3 mb-4">
           <span className="text-sm font-medium text-gray-700 dark:text-gray-300">
             {selectedDocuments.size} document{selectedDocuments.size !== 1 ? 's' : ''} selected
           </span>
           <div className="flex gap-2">
             <Button
               variant="outline"
               size="sm"
               onClick={() => setSelectedDocuments(new Set())}
             >
               Clear selection
             </Button>
             <Button
               variant="destructive"
               size="sm"
               onClick={() => setIsBulkDeleteOpen(true)}
             >
               Delete selected
             </Button>
           </div>
         </div>
       )}
       ```

    3. Add bulk delete confirmation dialog:
       ```typescript
       const [isBulkDeleteOpen, setIsBulkDeleteOpen] = useState(false);
       const [isBulkDeleting, setIsBulkDeleting] = useState(false);
       ```

       ```tsx
       <AlertDialog open={isBulkDeleteOpen} onOpenChange={setIsBulkDeleteOpen}>
         <AlertDialogContent>
           <AlertDialogHeader>
             <AlertDialogTitle>Delete {selectedDocuments.size} documents?</AlertDialogTitle>
             <AlertDialogDescription>
               This will permanently delete the selected documents and all their embeddings.
               This action cannot be undone.
             </AlertDialogDescription>
           </AlertDialogHeader>
           <AlertDialogFooter>
             <AlertDialogCancel disabled={isBulkDeleting}>Cancel</AlertDialogCancel>
             <AlertDialogAction
               onClick={handleBulkDelete}
               disabled={isBulkDeleting}
               className="bg-red-600 hover:bg-red-700"
             >
               {isBulkDeleting ? 'Deleting...' : `Delete ${selectedDocuments.size} documents`}
             </AlertDialogAction>
           </AlertDialogFooter>
         </AlertDialogContent>
       </AlertDialog>
       ```

    4. Implement handleBulkDelete:
       ```typescript
       const handleBulkDelete = async () => {
         setIsBulkDeleting(true);
         const toastId = toast.loading(`Deleting ${selectedDocuments.size} documents...`);

         try {
           const { bulkDeleteDocumentsAction } = await import('@/app/actions/documents');
           const result = await bulkDeleteDocumentsAction(Array.from(selectedDocuments));

           if (result.success) {
             toast.success(`Successfully deleted ${result.successCount} documents`, { id: toastId });
           } else {
             toast.warning(
               `Deleted ${result.successCount}, failed ${result.failCount}`,
               { id: toastId }
             );
           }

           setSelectedDocuments(new Set());
           setIsBulkDeleteOpen(false);
           router.refresh();
         } catch (error: any) {
           toast.error(`Bulk delete failed: ${error.message}`, { id: toastId });
         } finally {
           setIsBulkDeleting(false);
         }
       };
       ```
  </action>
  <verify>
    Run dev server and verify:
    - Bulk actions toolbar appears when documents selected
    - "Clear selection" button works
    - "Delete selected" opens confirmation dialog
    - Bulk delete executes and shows progress toast
    - Success/failure counts reported correctly
    - Selection cleared after bulk delete
  </verify>
  <done>Bulk delete working with confirmation, progress toast, and success/failure reporting</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete status and error tracking system with:
    - Enhanced status badges (icon + text, muted colors, pulsing animation)
    - Filter chips with counts for filtering by status
    - Document details side panel showing metadata and error details
    - Real-time status updates via Supabase realtime
    - Checkbox selection with bulk delete functionality
  </what-built>
  <how-to-verify>
    1. Navigate to http://localhost:3000/documents

    2. **Status Badges:**
       - Verify documents show status badge with icon + text
       - Colors should be muted (slate/sky/emerald/rose backgrounds)
       - If any document is "processing", verify pulsing animation

    3. **Filter Chips:**
       - Verify chips appear above document list
       - Each chip shows count: "Pending (2)", "Error (1)"
       - Click a chip to filter - only matching documents show
       - Click multiple chips to combine filters
       - Click "All" to clear filters

    4. **Document Details Panel:**
       - Click any document row - side panel should slide in from right
       - Panel shows: filename, status badge, upload date, MIME type
       - For error documents: verify error_details section appears
       - Download/Delete buttons in panel work

    5. **Real-time Updates:**
       - Open documents page in two browser tabs
       - Upload a new document in one tab
       - Verify document appears in both tabs
       - Verify toast notification appears

    6. **Checkbox Selection & Bulk Delete:**
       - Check individual documents via checkbox
       - Verify bulk actions toolbar appears
       - Use "Select all" checkbox in header
       - Click "Delete selected" and confirm
       - Verify all selected documents deleted

    7. **Requirements Verification:**
       - STAT-01: Status reflects pipeline state (check badge)
       - STAT-02: Error documents show error_details (if any exist)
       - STAT-03: Admin UI displays visual status indicators (verified above)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe specific issues found</resume-signal>
</task>

</tasks>

<verification>
1. Run `npm run dev:api` and navigate to /documents
2. Verify all status badges render correctly with icons and colors
3. Verify filter chips work with counts
4. Verify side panel opens and shows correct metadata
5. Verify real-time updates work across browser tabs
6. Verify checkbox selection and bulk delete functionality
7. Verify all STAT-01, STAT-02, STAT-03 requirements met
</verification>

<success_criteria>
- Checkbox selection working with select all and indeterminate state
- Bulk delete action deletes all selected documents
- Confirmation dialog shows before bulk delete
- Progress toast shows during bulk delete
- Complete Phase 3 requirements verified by human tester
</success_criteria>

<output>
After completion, create `.planning/phases/03-status-error-tracking/03-03-SUMMARY.md`
</output>
