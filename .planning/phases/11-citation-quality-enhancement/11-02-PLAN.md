---
phase: 11-citation-quality-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - apps/api/lib/vectorstore/VectorstoreService.ts
  - apps/api/app/api/chat/route.ts
  - apps/api/app/actions/inquiries.ts
  - apps/api/app/(admin)/inquiries/InquiryDetail.tsx
autonomous: true

must_haves:
  truths:
    - "RAG citations with page numbers are stored in salary_inquiries.details"
    - "Admin sees consolidated citations (document + pages) in inquiry detail view"
    - "Users see NO source references in chat responses"
  artifacts:
    - path: "apps/api/lib/vectorstore/VectorstoreService.ts"
      provides: "queryWithMetadata returns page_start and page_end"
      contains: "page_start"
    - path: "apps/api/app/api/chat/route.ts"
      provides: "Stores citations in inquiry details, no user-facing citations"
      contains: "citations"
    - path: "apps/api/app/(admin)/inquiries/InquiryDetail.tsx"
      provides: "Citations section in admin detail view"
      contains: "Quellenangaben"
  key_links:
    - from: "apps/api/app/api/chat/route.ts"
      to: "salary_inquiries.details.citations"
      via: "Supabase insert"
      pattern: "citations.*documentName"
    - from: "apps/api/app/(admin)/inquiries/InquiryDetail.tsx"
      to: "inquiry.details.citations"
      via: "React render"
      pattern: "details\\.citations"
---

<objective>
Integrate citations into chat API and admin dashboard

Purpose: Admin traceability - see which documents informed each salary inquiry
Output: Chat API stores citation metadata, admin UI displays consolidated citations
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-citation-quality-enhancement/11-CONTEXT.md
@.planning/phases/11-citation-quality-enhancement/11-01-SUMMARY.md

# Key files to modify
@apps/api/lib/vectorstore/VectorstoreService.ts
@apps/api/app/api/chat/route.ts
@apps/api/app/actions/inquiries.ts
@apps/api/app/(admin)/inquiries/InquiryDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update VectorstoreService to return page data</name>
  <files>apps/api/lib/vectorstore/VectorstoreService.ts</files>
  <action>
Update the queryWithMetadata method to include page information:

1. **Update return type** to include page data:
   ```typescript
   async queryWithMetadata(
     question: string,
     projectId: string,
     topK = 3
   ): Promise<Array<{
     content: string;
     similarity: number;
     metadata: {
       documentId: string;
       filename: string;
       chunkIndex: number;
       pageStart: number | null;  // NEW
       pageEnd: number | null;    // NEW
     }
   }>>
   ```

2. **Map page columns from SQL result**:
   - Extract page_start and page_end from result
   - Map to camelCase in metadata object

3. **Add helper function** to format page range for German locale:
   ```typescript
   export function formatPageRange(pageStart: number | null, pageEnd: number | null): string | null {
     if (pageStart === null) return null;
     if (pageEnd === null || pageEnd === pageStart) {
       return `S. ${pageStart}`;
     }
     return `S. ${pageStart}-${pageEnd}`;
   }
   ```

No changes to the query() method - it's used for internal RAG context and doesn't need page data.
  </action>
  <verify>
Run: `grep -n "pageStart\|pageEnd\|page_start\|page_end" apps/api/lib/vectorstore/VectorstoreService.ts`
Verify: Page fields are mapped in queryWithMetadata method

Run: `grep -n "formatPageRange" apps/api/lib/vectorstore/VectorstoreService.ts`
Verify: Helper function exists for German page formatting
  </verify>
  <done>
VectorstoreService.queryWithMetadata returns page data in metadata object
formatPageRange helper function formats pages in German style (S. N or S. N-M)
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove user-facing citations and store for admin</name>
  <files>apps/api/app/api/chat/route.ts</files>
  <action>
Modify the chat route to store citations for admin while hiding from users:

1. **Remove user-facing citations from question handling**:
   - Find the section handling `userIntent === 'question'` (around line 204)
   - Remove "[Quelle N: filename]" from the prompt sent to Gemini
   - Keep RAG context injection but without citation labels
   - Change prompt to NOT ask AI to cite sources in response

2. **Add citation type definition** at top of file:
   ```typescript
   interface Citation {
     documentId: string;
     documentName: string;
     pages: string | null;  // "S. 5" or "S. 5-7" or null
     similarity: number;
   }
   ```

3. **Build citations array** when RAG is used:
   - After queryWithMetadata call, build citations array
   - Consolidate by document (merge page numbers)
   - Only include chunks that have page data (strict quality per CONTEXT.md)
   - Take top 3 most relevant

4. **Store citations in salary_inquiry.details**:
   - When saving to salary_inquiries (around line 364), add citations field:
     ```typescript
     details: {
       ...calculationResult,
       job_details: jobData,
       tax_details: taxData,
       citations: citations  // NEW: Array of Citation objects
     }
     ```

5. **Also store citations for question-only interactions**:
   - When returning from question handling, if user later completes calculation,
     citations should be available
   - Track citations in a temporary variable that persists through the session
   - Add `ragCitations` field to formState to persist between calls:
     ```typescript
     // In formState, track RAG citations from questions
     if (nextFormState.userIntent === 'question' && ragCitations.length > 0) {
       nextFormState.ragCitations = ragCitations;
     }
     ```

IMPORTANT per CONTEXT.md decisions:
- Users see NO source references (no "Quelle:" in responses)
- Only cite chunks that have page data
- Top 3 most relevant chunks
- Consolidate by document name with multiple pages listed
  </action>
  <verify>
Run: `grep -n "Quelle" apps/api/app/api/chat/route.ts`
Verify: No "[Quelle" citation format in user-facing prompts

Run: `grep -n "citations" apps/api/app/api/chat/route.ts`
Verify: Citations stored in salary_inquiries details

Run: `grep -n "ragCitations" apps/api/app/api/chat/route.ts`
Verify: RAG citations tracked in formState
  </verify>
  <done>
Chat route:
- Removes "[Quelle N: filename]" from user-facing responses
- Builds citations array from RAG results with page data
- Consolidates citations by document name
- Stores citations in salary_inquiries.details
- Tracks ragCitations in formState for session persistence
  </done>
</task>

<task type="auto">
  <name>Task 3: Display citations in admin inquiry detail</name>
  <files>
apps/api/app/actions/inquiries.ts
apps/api/app/(admin)/inquiries/InquiryDetail.tsx
  </files>
  <action>
Update admin inquiry components to show citations:

1. **Update InquiryRow interface** in inquiries.ts:
   ```typescript
   export interface InquiryRow {
     // ... existing fields
     details: {
       // ... existing fields
       citations?: Array<{
         documentId: string;
         documentName: string;
         pages: string | null;
         similarity: number;
       }>;
       [key: string]: any;
     };
   }
   ```

2. **Add Citations section to InquiryDetail.tsx**:
   - Add after the Email section (at the end of the component)
   - Only show if inquiry.details.citations exists and has items
   - Display format per CONTEXT.md:
     - "TVÃ¶D_2025.pdf, S. 5, 12, 15" (consolidated pages per document)
   - Sort by similarity (highest first)

3. **Styling for citations section**:
   ```tsx
   {inquiry.details?.citations && inquiry.details.citations.length > 0 && (
     <div>
       <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-3">
         Quellenangaben
       </h3>
       <div className="space-y-2">
         {/* Consolidate citations by documentName */}
         {consolidateCitations(inquiry.details.citations).map((citation, index) => (
           <div key={index} className="text-sm text-gray-600 dark:text-gray-400">
             <span className="font-medium text-gray-900 dark:text-gray-100">
               {citation.documentName}
             </span>
             {citation.pages && (
               <span className="ml-1">, {citation.pages}</span>
             )}
           </div>
         ))}
       </div>
     </div>
   )}
   ```

4. **Add consolidation helper function**:
   ```typescript
   function consolidateCitations(citations: Citation[]): Array<{ documentName: string; pages: string }> {
     // Group by documentName
     // Merge page numbers into comma-separated list
     // Return sorted by most relevant (first citation's similarity)
   }
   ```

5. **Handle empty citations state** per CONTEXT.md (Claude's discretion):
   - If citations array is empty, don't show the section at all
   - No "Keine Quellen" message needed - absence is sufficient
  </action>
  <verify>
Run: `grep -n "citations" apps/api/app/actions/inquiries.ts`
Verify: InquiryRow interface includes citations field

Run: `grep -n "Quellenangaben\|citations" apps/api/app/(admin)/inquiries/InquiryDetail.tsx`
Verify: Citations section rendered in InquiryDetail

Run: `npm run build --prefix apps/api`
Verify: TypeScript compiles without errors
  </verify>
  <done>
Admin inquiry detail:
- Shows "Quellenangaben" section when citations exist
- Consolidates citations by document name
- Displays pages in German format (S. N, M, P)
- Hidden when no citations available
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. End-to-end verification:
   - Upload a PDF document and process it
   - Start a chat conversation with questions about the document
   - Complete a salary calculation
   - Check admin inquiry dashboard:
     - Expand the inquiry row
     - Verify "Quellenangaben" section appears
     - Verify document name and page numbers displayed

2. User experience verification:
   - In chat, ask a question that triggers RAG
   - Verify response has NO "[Quelle" or source references visible
   - Response should be clean, natural language only

3. Data verification:
   - Query salary_inquiries table
   - Verify details.citations array contains:
     - documentId
     - documentName
     - pages (in "S. N" format)
     - similarity score
</verification>

<success_criteria>
- [ ] VectorstoreService.queryWithMetadata returns pageStart and pageEnd
- [ ] formatPageRange helper formats pages in German style
- [ ] Chat route removes user-facing citation text
- [ ] Chat route stores citations array in salary_inquiries.details
- [ ] InquiryRow interface includes citations type
- [ ] InquiryDetail shows Quellenangaben section
- [ ] Citations consolidated by document name
- [ ] TypeScript builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-citation-quality-enhancement/11-02-SUMMARY.md`
</output>
