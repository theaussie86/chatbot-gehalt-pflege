---
phase: 04-edge-function-processing
plan: 04
type: execute
wave: 4
depends_on: ["04-03"]
files_modified:
  - supabase/functions/process-embeddings/index.ts
  - apps/api/components/DocumentManager.tsx
autonomous: false

must_haves:
  truths:
    - "Document upload triggers edge function execution"
    - "Chunks appear in document_chunks table with 768-dimensional embeddings"
    - "Status updates show in realtime UI during processing"
    - "Failed documents show error details in UI"
  artifacts:
    - path: "supabase/functions/process-embeddings/index.ts"
      provides: "Complete working edge function"
  key_links:
    - from: "documents INSERT"
      to: "edge function"
      via: "database webhook trigger"
    - from: "edge function"
      to: "document_chunks"
      via: "supabase.from('document_chunks').insert()"
---

<objective>
Deploy the fixed edge function and verify end-to-end document processing works.

Purpose: Plans 01-03 fixed the code. This plan deploys and verifies the complete pipeline works from upload through embedding to database storage.

Output: Verified working document processing pipeline with chunks appearing in database.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-edge-function-processing/04-CONTEXT.md

@supabase/functions/process-embeddings/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update UI to display chunk count and processing stage</name>
  <files>apps/api/components/DocumentManager.tsx</files>
  <action>
Update the DocumentManager UI to show chunk count and processing stage information.

1. **Add chunk_count and processing_stage to the document type** if not already present:
```typescript
interface Document {
  // ... existing fields
  chunk_count?: number;
  processing_stage?: string;
}
```

2. **Update the document details panel** to show chunk count for embedded documents:
```typescript
{doc.status === 'embedded' && doc.chunk_count && (
  <div className="text-sm text-muted-foreground">
    {doc.chunk_count} chunks created
  </div>
)}
```

3. **Update the status badge** to show processing stage when status is "processing":
```typescript
{doc.status === 'processing' && doc.processing_stage && (
  <span className="text-xs text-muted-foreground ml-2">
    ({doc.processing_stage})
  </span>
)}
```

4. **Include new fields in realtime subscription** (should already be included if selecting all fields).

5. **Add processing_stage to the document fetch query** if using select with specific columns.
  </action>
  <verify>
- Confirm chunk_count displays in document details for embedded documents
- Confirm processing_stage shows next to status badge during processing
- Confirm these fields update via realtime when document changes
  </verify>
  <done>
- UI shows chunk count for successfully embedded documents
- Processing stage visible during active processing
- Realtime updates include chunk_count and processing_stage
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete document processing pipeline:
- Fixed edge function with proper error handling
- Defensive embedding response parsing
- Promise.allSettled batch processing
- Gemini file cleanup in finally block
- Improved chunking (2000/100)
- File type validation and spreadsheet handling
- UI shows chunk count and processing stage
  </what-built>
  <how-to-verify>
**Prerequisites:**
- Ensure the edge function is deployed to Supabase (may need manual deploy via Supabase CLI or dashboard)
- Ensure the database webhook trigger is configured to call the edge function on documents INSERT

**Test 1: Basic PDF Processing**
1. Go to the documents admin page
2. Upload a small text-based PDF (1-5 pages)
3. Watch the status update in realtime:
   - Should see "processing (extracting text)"
   - Then "processing (embedding chunks)"
   - Then "embedded" with chunk count
4. Check Supabase dashboard -> Table editor -> document_chunks
   - Verify chunks exist for the uploaded document
   - Verify embeddings are 768-dimensional arrays

**Test 2: Processing Failure Handling**
1. Upload an image-only PDF (a scanned document)
2. Verify status changes to "error"
3. Open document details panel
4. Verify error_details shows the "contains only images" message

**Test 3: Text File Processing**
1. Upload a .txt file
2. Verify it processes successfully
3. Verify chunks appear in document_chunks table

**Test 4: Chunk Count Display**
1. After successful processing, check the document in the UI
2. Verify chunk count displays (e.g., "42 chunks created")

**Expected Results:**
- PDF processes and creates chunks in database
- Status updates visible in realtime during processing
- Error details show when processing fails
- Chunk count visible after successful processing
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues found.

If the edge function isn't deployed or webhook isn't configured, type "needs-deploy" and I'll provide instructions.
  </resume-signal>
</task>

</tasks>

<verification>
Human verification confirms:
1. Documents process successfully (chunks appear in database)
2. Status updates show in realtime
3. Error handling works (image-only PDFs show error)
4. Chunk count displays in UI
</verification>

<success_criteria>
- Document uploaded triggers edge function execution
- Chunks appear in document_chunks table with 768-dimensional embeddings
- Status updates show during processing (extracting text -> embedding chunks)
- Failed documents show error details
- Chunk count visible for embedded documents
</success_criteria>

<output>
After completion, create `.planning/phases/04-edge-function-processing/04-04-SUMMARY.md`
</output>
