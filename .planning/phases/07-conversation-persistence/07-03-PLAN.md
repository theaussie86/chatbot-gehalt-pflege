---
phase: 07-conversation-persistence
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - apps/web/components/DoiConsentForm.tsx
  - apps/web/App.tsx
  - apps/web/services/gemini.ts
  - apps/api/app/api/chat/route.ts
  - apps/api/app/api/email-export/route.ts
  - apps/api/lib/emailTemplate.ts
autonomous: true

user_setup:
  - service: email-provider
    why: "Sending formatted result emails to users after DOI consent"
    env_vars:
      - name: RESEND_API_KEY
        source: "Create account at resend.com -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify sender domain or use onboarding@resend.dev for testing"
        location: "Resend Dashboard -> Domains"

must_haves:
  truths:
    - "After calculation completes, user sees inline DOI consent form with email input and marketing consent checkbox"
    - "User cannot send email without checking the consent checkbox"
    - "User receives formatted HTML email with their inputs AND calculated results"
    - "Email contains: Tarif, Stufe, Steuerklasse, Brutto, Netto, all tax breakdowns, all social security breakdowns"
    - "User email is saved to the salary_inquiries record in Supabase"
    - "Admin sees the email in the inquiry dashboard"
  artifacts:
    - path: "apps/web/components/DoiConsentForm.tsx"
      provides: "Inline email + consent checkbox form rendered in chat"
      exports: ["DoiConsentForm"]
    - path: "apps/api/app/api/email-export/route.ts"
      provides: "POST endpoint that sends formatted result email"
      exports: ["POST"]
    - path: "apps/api/lib/emailTemplate.ts"
      provides: "HTML email template function for salary results"
      exports: ["buildSalaryEmail"]
  key_links:
    - from: "apps/web/components/DoiConsentForm.tsx"
      to: "/api/email-export"
      via: "fetch POST with email, consent, inquiryData"
      pattern: "fetch.*email-export"
    - from: "apps/api/app/api/email-export/route.ts"
      to: "apps/api/lib/emailTemplate.ts"
      via: "buildSalaryEmail generates HTML body"
      pattern: "buildSalaryEmail"
    - from: "apps/api/app/api/email-export/route.ts"
      to: "salary_inquiries"
      via: "UPDATE to save email to inquiry record"
      pattern: "salary_inquiries.*email"
---

<objective>
Email export with DOI (Double Opt-In) consent for completed salary calculations.

Purpose: Users can export their salary calculation results to email (CONV-06). Email capture requires explicit DOI consent via inline form with checkbox (CONV-04 email association). The email contains the full breakdown of user inputs and calculated results. This serves dual purpose: result delivery and marketing opt-in.

Output: DOI consent form component in chat widget, email export API endpoint, HTML email template, email saved to inquiry record for admin visibility.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-conversation-persistence/07-CONTEXT.md

# Depends on Plan 01 outputs:
@apps/web/App.tsx
@apps/web/types.ts
@apps/web/services/gemini.ts

# Depends on Plan 02 outputs:
@apps/api/app/actions/inquiries.ts

# Existing references:
@apps/api/app/api/chat/route.ts
@apps/api/types/form.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DOI consent form component and chat integration</name>
  <files>
    apps/web/components/DoiConsentForm.tsx
    apps/web/App.tsx
    apps/web/types.ts
  </files>
  <action>
Create `apps/web/components/DoiConsentForm.tsx` as an inline form that appears in the chat after calculation completes:

```typescript
interface DoiConsentFormProps {
  onSubmit: (email: string) => void;
  isLoading: boolean;
  isSubmitted: boolean;
}
```

The form renders inside the chat message area (not as a modal or popup):
- Email input field: `<input type="email" placeholder="deine@email.de" />`
- Consent checkbox with German label:
  "Ich stimme zu, dass meine E-Mail-Adresse gespeichert wird und ich per E-Mail kontaktiert werden darf. Die Ergebniszusammenfassung wird an diese Adresse gesendet."
- Submit button: "Ergebnis per E-Mail senden" -- disabled unless:
  - Email is valid (basic email regex check)
  - Consent checkbox is checked
- Loading state: button shows spinner while sending
- Success state: Shows "E-Mail wurde gesendet!" confirmation message with a checkmark, hides the form inputs
- Error state: Shows "Fehler beim Senden. Bitte versuche es erneut." with retry option

Style the form as a card that fits within the chat flow:
- White background, rounded corners, subtle border (matching bot message style)
- Compact layout: email input full width, checkbox below, button below
- Use existing theme CSS variables for the button color
- Touch-friendly: input and button have adequate tap targets (min 44px height)

Update `apps/web/types.ts`:
- Add to the `Message` interface: `showDoiForm?: boolean;` -- flag to render the DOI form instead of/in addition to message text

Update `apps/web/App.tsx`:
- After a calculation result is received (when formState transitions to 'completed'):
  - Add a bot message with `showDoiForm: true` and text like "Mochtest du dein Ergebnis per E-Mail erhalten?"
  - This message renders the DoiConsentForm component
- In MessageBubble (or in App.tsx's message rendering), check for `showDoiForm` and render `<DoiConsentForm>` below the message text
- When DoiConsentForm's `onSubmit` fires with the email:
  - Call a new function `sendEmailExport(email, formState)` that POSTs to `/api/email-export`
  - Pass: email, consent: true, inquiryData (the calculation result + job details + tax details from formState)
  - The API endpoint URL should be derived from the existing `apiEndpoint` config (replace `/api/chat` with `/api/email-export`, or construct from base URL)
- Save the email to local conversation state (optional, for display purposes)

Add `sendEmailExport` to `apps/web/services/gemini.ts` (or a new service file -- but keeping it in gemini.ts is simpler since it already has the config):

```typescript
export const sendEmailExport = async (
  email: string,
  inquiryData: {
    jobDetails: Record<string, any>;
    taxDetails: Record<string, any>;
    calculationResult: Record<string, any>;
  },
  projectId: string
): Promise<{ success: boolean; error?: string }> => {
  // POST to /api/email-export (derive URL from apiEndpoint config)
  // Body: { email, consent: true, inquiryData, projectId }
  // Return { success } or { success: false, error: message }
}
```

IMPORTANT per CONTEXT.md: DOI is a hard requirement -- no email sending without explicit consent. The checkbox MUST be checked. The form validates this client-side, and the API validates it server-side.
  </action>
  <verify>
Run `cd /Users/cweissteiner/NextJS/chatbot-gehalt-pflege/apps/web && npx tsc --noEmit` to verify compilation. Verify:
1. DoiConsentForm renders email input, checkbox, and submit button
2. Submit disabled without consent checkbox checked
3. App.tsx shows DOI form after calculation completes
4. sendEmailExport function calls /api/email-export endpoint
5. Success/error states handled in the form UI
  </verify>
  <done>
DOI consent form appears inline in chat after calculation. Email input + consent checkbox required. Submit calls /api/email-export. Success shows confirmation, error shows retry option. Form is touch-friendly and styled to match chat UI.
  </done>
</task>

<task type="auto">
  <name>Task 2: Email export API endpoint and HTML template</name>
  <files>
    apps/api/app/api/email-export/route.ts
    apps/api/lib/emailTemplate.ts
  </files>
  <action>
**1. Create `apps/api/lib/emailTemplate.ts`** -- HTML email template builder:

```typescript
interface SalaryEmailData {
  // User inputs
  tarif?: string;
  gruppe?: string;
  stufe?: string;
  hours?: number;
  state?: string;
  taxClass?: string;
  churchTax?: boolean | string;
  numberOfChildren?: number;
  // Calculation results
  brutto: number;
  netto: number;
  taxes: {
    lohnsteuer: number;
    soli: number;
    kirchensteuer: number;
  };
  socialSecurity: {
    kv: number;
    rv: number;
    av: number;
    pv: number;
  };
  year: number;
}

export function buildSalaryEmail(data: SalaryEmailData): string {
  // Returns a complete HTML email string
}
```

The HTML email must contain (per CONTEXT.md -- "both what the user entered AND the calculated result"):
- Header: "Deine Gehaltsberechnung" with year
- Section 1: "Deine Angaben" (user inputs):
  - Tarifvertrag, Entgeltgruppe, Erfahrungsstufe, Wochenstunden, Bundesland
  - Steuerklasse, Kirchensteuer (Ja/Nein), Anzahl Kinder
- Section 2: "Berechnungsergebnis" (results):
  - Bruttogehalt (monthly)
  - Nettogehalt (monthly)
- Section 3: "Abzuge im Detail":
  - Lohnsteuer, Solidaritatszuschlag, Kirchensteuer
  - Krankenversicherung, Rentenversicherung, Arbeitslosenversicherung, Pflegeversicherung
- Footer: "Diese Berechnung wurde mit dem Pflege Gehalt Chatbot erstellt." + disclaimer that values are estimates

Format all currency as EUR using German formatting (1.234,56 EUR). Use inline CSS (email clients don't support external stylesheets). Clean, professional look with:
- Max-width 600px centered container
- Light gray background (#f5f5f5)
- White content cards
- Table layout for line items
- Primary color for headers (use hardcoded #2563eb since emails can't use CSS variables)

**2. Create `apps/api/app/api/email-export/route.ts`** -- POST endpoint:

```typescript
export async function POST(request: Request) {
  // 1. Parse body: { email, consent, inquiryData, projectId }
  // 2. Validate: email format, consent === true (server-side DOI check)
  // 3. Build HTML email using buildSalaryEmail(inquiryData)
  // 4. Send email via Resend (npm package "resend")
  // 5. Save email to salary_inquiries record (UPDATE ... SET email = ?)
  // 6. Return { success: true } or { error: string }
}
```

Implementation details:
- Install `resend` package: The executor should run `cd apps/api && npm install resend`
- Use Resend for email sending (simple API, generous free tier, great DX):
  ```typescript
  import { Resend } from 'resend';
  const resend = new Resend(process.env.RESEND_API_KEY);

  await resend.emails.send({
    from: 'Pflege Gehalt Chatbot <noreply@yourdomain.com>',
    to: email,
    subject: `Deine Gehaltsberechnung ${new Date().getFullYear()}`,
    html: buildSalaryEmail(emailData),
  });
  ```
- If RESEND_API_KEY is not set, return error: "Email service not configured"
- From address: Use `onboarding@resend.dev` for development, configure real domain later

Save email to inquiry record:
- After sending successfully, UPDATE the most recent salary_inquiries record matching the projectId:
  ```typescript
  const supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_KEY!);
  await supabase
    .from('salary_inquiries')
    .update({ email })
    .eq('public_key', projectId)
    .order('created_at', { ascending: false })
    .limit(1);
  ```
- Use the admin client (service role) since this is a backend operation, not user-authenticated.
- If the update fails, log error but still return success (email was sent -- the save is secondary).

Rate limiting: Reuse the same IP-based rate limiting pattern from the chat route (check request_logs table). Limit email sends to 5 per IP per 60 seconds to prevent abuse.

CORS: Add OPTIONS handler matching the chat route pattern. Allow the widget origin.

Security:
- Validate email format server-side (regex or simple check)
- Require `consent === true` in the request body
- Rate limit to prevent spam
- Don't expose internal errors to client

Add `RESEND_API_KEY` to the environment check. If missing, the endpoint returns 503 with "Email service not configured" (graceful degradation).
  </action>
  <verify>
1. Run `cd /Users/cweissteiner/NextJS/chatbot-gehalt-pflege/apps/api && npm install resend` to install dependency
2. Run `npm run build` to verify compilation
3. Verify `POST /api/email-export` endpoint exists
4. Verify `buildSalaryEmail` generates valid HTML with all required sections
5. Verify consent is validated server-side
6. Verify email is saved to salary_inquiries
7. Verify rate limiting is applied
  </verify>
  <done>
Email export endpoint at `/api/email-export` sends formatted HTML email via Resend. Email contains all user inputs (Tarif, Stufe, Steuerklasse, etc.) and full calculation breakdown (Brutto, Netto, taxes, social security). Consent validated server-side. Email saved to salary_inquiries record for admin visibility. Rate limited. CORS configured.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds for both apps (web widget and API)
2. DOI consent form appears after calculation completes in chat
3. Form validates email format and consent checkbox
4. POST /api/email-export sends HTML email via Resend
5. Email contains both user inputs AND calculated results
6. Email saved to salary_inquiries record (admin can see it in Plan 02 dashboard)
7. Rate limiting prevents email spam
8. Graceful degradation if RESEND_API_KEY not configured
</verification>

<success_criteria>
- CONV-06: User exports conversation/result to email after providing consent
- CONV-04: User email saved to salary_inquiries and visible in admin dashboard
- DOI hard requirement met: no email sent without explicit consent checkbox
- Email contains ALL required data: user inputs (Tarif, Stufe, Steuerklasse, hours, state) + full breakdown (Brutto, Netto, Lohnsteuer, Soli, Kirchensteuer, KV, RV, AV, PV)
- Rate limiting prevents abuse
</success_criteria>

<output>
After completion, create `.planning/phases/07-conversation-persistence/07-03-SUMMARY.md`
</output>
