---
phase: 07-conversation-persistence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/app/(admin)/inquiries/page.tsx
  - apps/api/app/(admin)/inquiries/InquiryTable.tsx
  - apps/api/app/(admin)/inquiries/InquiryDetail.tsx
  - apps/api/app/(admin)/layout.tsx
  - apps/api/app/actions/inquiries.ts
autonomous: true

user_setup:
  - service: supabase-database
    why: "Admin inquiry dashboard requires DB schema changes and RLS policy"
    dashboard_config:
      - task: "Add email column to salary_inquiries table"
        location: "Supabase Dashboard -> SQL Editor -> Run: ALTER TABLE salary_inquiries ADD COLUMN IF NOT EXISTS email TEXT;"
      - task: "Add RLS policy for authenticated admin read access"
        location: "Supabase Dashboard -> SQL Editor -> Run: CREATE POLICY \"allow_authenticated_read\" ON salary_inquiries FOR SELECT TO authenticated USING (true);"

must_haves:
  truths:
    - "Admin views list of salary inquiries with tariff, Stufe, gross, net, tax class, date columns"
    - "Admin expands an inquiry row to see full tax breakdown and conversation excerpts"
    - "Admin filters inquiries by date range and tariff type"
    - "Admin sees user email associated with each salary inquiry (if provided)"
    - "Inquiries table is protected by RLS (admin auth required)"
  artifacts:
    - path: "apps/api/app/(admin)/inquiries/page.tsx"
      provides: "Admin inquiries page with data fetching"
      min_lines: 30
    - path: "apps/api/app/(admin)/inquiries/InquiryTable.tsx"
      provides: "Table component with expandable rows and filters"
      min_lines: 80
    - path: "apps/api/app/actions/inquiries.ts"
      provides: "Server action for fetching inquiries with filters"
      exports: ["getInquiries"]
  key_links:
    - from: "apps/api/app/(admin)/inquiries/page.tsx"
      to: "apps/api/app/actions/inquiries.ts"
      via: "Server action call to fetch inquiry data"
      pattern: "getInquiries"
    - from: "apps/api/app/(admin)/inquiries/InquiryTable.tsx"
      to: "InquiryDetail"
      via: "Expandable row renders InquiryDetail on click"
      pattern: "InquiryDetail"
    - from: "apps/api/app/(admin)/layout.tsx"
      to: "/inquiries"
      via: "Sidebar navigation link"
      pattern: "href.*inquiries"
---

<objective>
Admin inquiry dashboard showing structured salary calculation data with filters and detail views.

Purpose: Admins gain visibility into completed salary inquiries (CONV-03). Each inquiry shows structured job details, tax details, and calculated results. Admins can see user email when available (CONV-04). This provides business intelligence about chatbot usage patterns.

Output: Admin inquiries page with sortable/filterable table, expandable detail rows, server action for data fetching, and sidebar navigation link.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-conversation-persistence/07-CONTEXT.md

@apps/api/app/(admin)/layout.tsx
@apps/api/app/(admin)/page.tsx
@apps/api/app/actions/documents.ts
@apps/api/app/api/chat/route.ts
@apps/api/utils/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database preparation and server action for inquiries</name>
  <files>
    apps/api/app/actions/inquiries.ts
  </files>
  <action>
First, check the existing `salary_inquiries` table structure. The chat route already inserts into it (see `route.ts` lines 360-375):
```typescript
.from('salary_inquiries')
.insert({
    public_key: activeProjectId,
    gruppe: jobData.group || 'P7',
    stufe: jobData.experience || '2',
    tarif: jobData.tarif || 'tvoed',
    jahr: new Date().getFullYear(),
    brutto: monthlyBrutto,
    netto: monthlyNetto,
    details: {
        ...calculationResult,
        job_details: jobData,
        tax_details: taxData
    }
})
```

The table already stores structured data. The `details` JSONB column contains the full tax breakdown (lohnsteuer, soli, kirchensteuer, social security) plus job_details and tax_details objects.

For the email field: The table likely has no `email` column yet. The required DB changes (ALTER TABLE for email column, CREATE POLICY for RLS) are documented in the `user_setup` frontmatter above. The execute-plan workflow will surface these to the user at the right time.

Create `apps/api/app/actions/inquiries.ts`:

```typescript
"use server";

import { createClient } from "../../utils/supabase/server";

export interface InquiryFilters {
  dateFrom?: string;    // ISO date string
  dateTo?: string;      // ISO date string
  tarif?: string;       // 'tvoed' | 'tv-l' | 'avr' | '' (all)
  sortBy?: string;      // Column name, default 'created_at'
  sortOrder?: 'asc' | 'desc'; // Default 'desc'
}

export interface InquiryRow {
  id: string;
  created_at: string;
  tarif: string;
  gruppe: string;
  stufe: string;
  brutto: number;
  netto: number;
  email?: string | null;
  details: {
    taxes?: { lohnsteuer: number; soli: number; kirchensteuer: number };
    socialSecurity?: { kv: number; rv: number; av: number; pv: number };
    job_details?: Record<string, any>;
    tax_details?: Record<string, any>;
    [key: string]: any;
  };
}

export async function getInquiries(filters?: InquiryFilters): Promise<{
  data: InquiryRow[] | null;
  error: string | null;
  count: number;
}> {
  const supabase = await createClient();

  // Verify admin authentication
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return { data: null, error: "Unauthorized", count: 0 };
  }

  let query = supabase
    .from("salary_inquiries")
    .select("*", { count: "exact" });

  // Apply filters
  if (filters?.dateFrom) {
    query = query.gte("created_at", filters.dateFrom);
  }
  if (filters?.dateTo) {
    // Add 1 day to include the end date fully
    const endDate = new Date(filters.dateTo);
    endDate.setDate(endDate.getDate() + 1);
    query = query.lt("created_at", endDate.toISOString());
  }
  if (filters?.tarif) {
    query = query.eq("tarif", filters.tarif);
  }

  // Sort
  const sortColumn = filters?.sortBy || "created_at";
  const sortOrder = filters?.sortOrder || "desc";
  query = query.order(sortColumn, { ascending: sortOrder === "asc" });

  // Limit to 100 most recent (pagination can be added later)
  query = query.limit(100);

  const { data, error, count } = await query;

  if (error) {
    console.error("[Inquiries] Failed to fetch:", error);
    return { data: null, error: error.message, count: 0 };
  }

  return { data: data as InquiryRow[], error: null, count: count || 0 };
}
```

Follow the same server action pattern as `apps/api/app/actions/documents.ts` -- "use server" directive, create supabase client, verify auth, return `{ data, error }` shape.

IMPORTANT: The Supabase client from `createClient()` uses the authenticated user's session. The `salary_inquiries` table may not have RLS policies yet (the chat route uses `getSupabaseAdmin()` which bypasses RLS). For the admin dashboard to work, the RLS policy documented in `user_setup` must be applied. If the query returns empty despite data existing, RLS is the likely cause.
  </action>
  <verify>
Run `cd /Users/cweissteiner/NextJS/chatbot-gehalt-pflege && npx tsc --noEmit -p apps/api/tsconfig.json` (or equivalent) to verify TypeScript compiles. Verify:
1. `inquiries.ts` exports `getInquiries` function with proper types
2. Function uses authenticated Supabase client
3. Filters (date range, tariff) are applied correctly
4. Returns typed `InquiryRow[]`
  </verify>
  <done>
Server action `getInquiries` fetches salary inquiries with date range and tariff filters. Returns typed InquiryRow array with structured details. Auth-protected via Supabase client. DB setup (email column, RLS policy) documented in plan user_setup frontmatter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin inquiry dashboard page with expandable table</name>
  <files>
    apps/api/app/(admin)/inquiries/page.tsx
    apps/api/app/(admin)/inquiries/InquiryTable.tsx
    apps/api/app/(admin)/inquiries/InquiryDetail.tsx
    apps/api/app/(admin)/layout.tsx
  </files>
  <action>
Create the admin inquiry dashboard with 3 files:

**1. `apps/api/app/(admin)/inquiries/page.tsx`** -- Server component page:
- Call `getInquiries()` to fetch initial data (no filters, most recent 100)
- Render page title "Gehaltsanfragen" (German, consistent with admin UI)
- Render `<InquiryTable />` client component with initial data passed as props
- Follow the same pattern as other admin pages (see `documents/page.tsx` for reference)

**2. `apps/api/app/(admin)/inquiries/InquiryTable.tsx`** -- Client component ("use client"):
- Props: `initialData: InquiryRow[]`, `totalCount: number`
- Filter bar at top with:
  - Date range: two `<input type="date">` fields (Von / Bis)
  - Tariff select: `<select>` with options: Alle, TVoD, TV-L, AVR
  - "Aktualisieren" (Refresh) button that re-fetches with `getInquiries(filters)`
  - Show total count: "X Anfragen"
- Table with columns:
  - Datum (formatted: dd.MM.yyyy, from `created_at`)
  - Tarif (tarif field, uppercase)
  - Gruppe (gruppe field)
  - Stufe (stufe field)
  - Brutto (formatted: EUR currency, `brutto`)
  - Netto (formatted: EUR currency, `netto`)
  - E-Mail (email field, show "-" if null)
  - Expand button (chevron icon)
- Each row is clickable to expand/collapse detail view
- When expanded, render `<InquiryDetail />` below the row
- Sort by date descending by default
- Use Tailwind for styling. Match the existing admin UI style (white cards, shadows, dark mode support via `dark:` classes). Look at `documents/page.tsx` and `layout.tsx` for the visual style.
- Format currency: `new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(value)`
- Format date: `new Date(dateStr).toLocaleDateString('de-DE')`

**3. `apps/api/app/(admin)/inquiries/InquiryDetail.tsx`** -- Detail view component:
- Props: `inquiry: InquiryRow`
- Displays in a bordered expandable section below the row:
  - **Berufliche Daten** section: All job_details fields from `inquiry.details.job_details`
    - Tarifvertrag, Entgeltgruppe, Erfahrungsstufe, Wochenstunden, Bundesland
  - **Steuerliche Daten** section: All tax_details fields from `inquiry.details.tax_details`
    - Steuerklasse, Kirchensteuer (Ja/Nein), Anzahl Kinder
  - **Steuerabzuge** section: Tax breakdown from `inquiry.details.taxes`
    - Lohnsteuer, Solidaritatszuschlag, Kirchensteuer (EUR amounts)
  - **Sozialabgaben** section: From `inquiry.details.socialSecurity`
    - Krankenversicherung, Rentenversicherung, Arbeitslosenversicherung, Pflegeversicherung
  - **E-Mail**: Email address if available
- Use a 2-column grid layout for the detail sections
- Format all currency values as EUR
- Handle missing/null values gracefully (show "-")

**4. Update `apps/api/app/(admin)/layout.tsx`**:
- Add a new sidebar navigation link for "Inquiries" / "Anfragen":
  ```tsx
  <Link href="/inquiries" className="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded dark:text-gray-300 dark:hover:bg-gray-700">
    Anfragen
  </Link>
  ```
- Place it after "Documents" in the nav order

Style notes:
- Follow existing admin patterns. The admin uses Tailwind with dark mode.
- Use lucide-react icons (already installed): `ChevronDown`, `ChevronRight` for expand/collapse, `Search` or `Filter` for filter bar
- No need for TanStack React Query here -- server actions with useState are sufficient for this simple list view with manual refresh
  </action>
  <verify>
Run `cd /Users/cweissteiner/NextJS/chatbot-gehalt-pflege && npm run build` to verify the Next.js build succeeds. Verify:
1. `/inquiries` route exists and renders
2. InquiryTable shows columns: Datum, Tarif, Gruppe, Stufe, Brutto, Netto, E-Mail
3. Filters for date range and tariff type work
4. Expanding a row shows InquiryDetail with all breakdown sections
5. Layout sidebar includes "Anfragen" link
6. Currency formatted as EUR, dates as dd.MM.yyyy
  </verify>
  <done>
Admin dashboard at `/inquiries` shows salary inquiries in a filterable table. Rows expand to show full tax breakdown (Lohnsteuer, Soli, Kirchensteuer, SV-Beitrage), job details, and tax details. Sidebar navigation updated. All text in German.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run build` passes for the API app
2. Server action `getInquiries` returns typed data with filters applied
3. Admin page renders table with correct columns
4. Expandable rows show structured detail view
5. Sidebar includes "Anfragen" link
6. Empty states handled (no inquiries yet shows friendly message)
7. Date/currency formatting follows German conventions
</verification>

<success_criteria>
- CONV-03: Admin views structured salary inquiry data (tariff, Stufe, gross, net, tax class, full tax breakdown) in expandable table at `/inquiries`
- CONV-04: Admin sees user email column (shows "-" when not provided, ready for Plan 03 to populate)
- Filter by date range and tariff type works
- Sort by date descending by default
- Detail view shows all tax breakdown fields (Lohnsteuer, Soli, Kirchensteuer, KV, RV, AV, PV)
</success_criteria>

<output>
After completion, create `.planning/phases/07-conversation-persistence/07-02-SUMMARY.md`
</output>
