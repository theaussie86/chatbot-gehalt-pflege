---
phase: 09-suggested-response-chips
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - apps/web/components/SuggestionChips.tsx
  - apps/web/App.tsx
  - apps/web/services/gemini.ts
  - apps/web/types.ts
autonomous: true

must_haves:
  truths:
    - "User sees suggestion chips above the input field after bot responds"
    - "User taps chip and text fills input field (not auto-submit)"
    - "User can edit filled text before sending"
    - "Chips have minimum 44x44px tap target for mobile accessibility"
    - "Chips fade (but remain accessible) when user types manually"
    - "Chips clear after message sends, new chips appear with next bot response"
    - "Tapping another chip replaces input text (single selection)"
  artifacts:
    - path: "apps/web/components/SuggestionChips.tsx"
      provides: "SuggestionChips component with tap-to-fill behavior"
      min_lines: 50
    - path: "apps/web/App.tsx"
      provides: "SuggestionChips integration above input"
      contains: "SuggestionChips"
  key_links:
    - from: "apps/web/App.tsx"
      to: "apps/web/components/SuggestionChips.tsx"
      via: "import and render"
      pattern: "<SuggestionChips"
    - from: "apps/web/services/gemini.ts"
      to: "API response"
      via: "suggestions field extraction"
      pattern: "suggestions"
---

<objective>
Create the SuggestionChips UI component that displays quick reply options above the input field with tap-to-fill behavior.

Purpose: Provide touch-friendly quick replies for mobile users, reducing typing friction.
Output: Functional chip interface that fills input on tap, with proper animations and accessibility.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-suggested-response-chips/09-CONTEXT.md
@.planning/phases/09-suggested-response-chips/09-01-SUMMARY.md

# Key existing files
@apps/web/App.tsx
@apps/web/types.ts
@apps/web/services/gemini.ts
@apps/web/components/MessageBubble.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update gemini service and types to handle suggestions</name>
  <files>apps/web/services/gemini.ts, apps/web/types.ts</files>
  <action>
    **Update apps/web/types.ts:**

    Add suggestions to the response interface if not already present. Note: Message type already has `options?: string[]` which is used for inline message options. We're adding a new concept - floating suggestions that appear above input.

    No type changes needed if we track suggestions in App.tsx state directly.

    **Update apps/web/services/gemini.ts:**

    Update the return type and extraction to include suggestions:

    ```typescript
    export const sendMessageToGemini = async (
      userMessage: string,
      history: Message[],
      currentFormState?: FormState
    ): Promise<{ text: string; formState?: FormState; inquiryId?: string; suggestions?: string[] }> => {
      // ... existing code ...

      const data = await response.json();
      return {
        text: data.text || "",
        formState: data.formState,
        inquiryId: data.inquiryId,
        suggestions: data.suggestions || [] // ADD: Extract suggestions from response
      };
    };
    ```

    Also update the error return to include empty suggestions:
    ```typescript
    return {
      text: '[PROGRESS: 0] Entschuldigung...',
      suggestions: [] // ADD
    };
    ```
  </action>
  <verify>
    TypeScript compiles: `cd apps/web && npx tsc --noEmit`
  </verify>
  <done>
    gemini.ts extracts and returns suggestions array from API response.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SuggestionChips component with tap-to-fill behavior</name>
  <files>apps/web/components/SuggestionChips.tsx</files>
  <action>
    Create `apps/web/components/SuggestionChips.tsx`:

    ```typescript
    import React from 'react';

    interface SuggestionChipsProps {
      suggestions: string[];
      onSelect: (text: string) => void;
      isTyping: boolean; // True when user has typed something manually
      disabled?: boolean; // True when loading/sending
    }

    export const SuggestionChips: React.FC<SuggestionChipsProps> = ({
      suggestions,
      onSelect,
      isTyping,
      disabled = false
    }) => {
      // Don't render if no suggestions
      if (!suggestions || suggestions.length === 0) {
        return null;
      }

      return (
        <div
          className={`
            flex flex-wrap gap-2 px-4 pb-2
            transition-opacity duration-200
            ${isTyping ? 'opacity-40' : 'opacity-100'}
          `}
        >
          {suggestions.map((suggestion, index) => (
            <button
              key={`${suggestion}-${index}`}
              onClick={() => !disabled && onSelect(suggestion)}
              disabled={disabled}
              className={`
                px-4 py-2
                min-h-[44px] min-w-[44px]
                text-sm font-medium
                rounded-full
                border border-[var(--primary-border)]
                bg-white
                text-[var(--primary-color)]
                shadow-sm
                transition-all duration-150
                ${disabled
                  ? 'opacity-50 cursor-not-allowed'
                  : 'hover:bg-[var(--primary-light-hover)] hover:border-[var(--primary-color)] active:scale-95 cursor-pointer'
                }
              `}
            >
              {suggestion}
            </button>
          ))}
        </div>
      );
    };
    ```

    **Key features:**
    - Min 44x44px tap targets (min-h-[44px] min-w-[44px])
    - Horizontal flex-wrap layout
    - Fade to 40% opacity when user is typing (isTyping prop)
    - Disabled state while loading
    - Uses CSS variables from theme (--primary-color, etc.)
    - Smooth transitions for hover/active states
  </action>
  <verify>
    File exists: `ls apps/web/components/SuggestionChips.tsx`
    TypeScript compiles: `cd apps/web && npx tsc --noEmit`
  </verify>
  <done>
    SuggestionChips component exists with proper styling and accessibility.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate SuggestionChips into App.tsx</name>
  <files>apps/web/App.tsx</files>
  <action>
    Update App.tsx to:
    1. Track suggestions in state
    2. Render SuggestionChips above the input field
    3. Handle chip selection (fill input, don't auto-submit)
    4. Clear suggestions when message is sent

    **Add import:**
    ```typescript
    import { SuggestionChips } from './components/SuggestionChips';
    ```

    **Add state for suggestions:**
    ```typescript
    const [suggestions, setSuggestions] = useState<string[]>([]);
    ```

    **Update handleSendMessage to extract and store suggestions:**
    Find the destructuring of the API response and add suggestions:
    ```typescript
    const { text: rawText, formState: newFormState, inquiryId: newInquiryId, suggestions: newSuggestions } = await sendMessageToGemini(
      textToSend,
      messages,
      formState
    );
    ```

    After processing the response, update suggestions:
    ```typescript
    // Set new suggestions (or clear if none)
    setSuggestions(newSuggestions || []);
    ```

    **Clear suggestions when sending:**
    At the start of handleSendMessage (before setIsLoading), add:
    ```typescript
    setSuggestions([]); // Clear suggestions while sending
    ```

    **Add chip selection handler:**
    ```typescript
    const handleChipSelect = (text: string) => {
      setInputValue(text);
      inputRef.current?.focus();
    };
    ```

    **Render SuggestionChips in the footer, ABOVE the input container:**
    Find the footer section and add SuggestionChips between the footer opening and the input div:

    ```tsx
    {/* Input Area */}
    <footer className="bg-white border-t border-slate-200">
      {/* Suggestion Chips - above input */}
      <div className="pt-2">
        <SuggestionChips
          suggestions={suggestions}
          onSelect={handleChipSelect}
          isTyping={inputValue.length > 0}
          disabled={isLoading}
        />
      </div>

      {/* Input container */}
      <div className="p-4 pt-0"> {/* Adjust padding since chips have their own */}
        <div className="relative flex items-end gap-2 ...">
    ```

    **Also update handleReset to clear suggestions:**
    ```typescript
    setSuggestions([]);
    ```

    **Update auto-resume (load saved conversation) to clear suggestions:**
    In the useEffect that loads saved conversation, suggestions should start empty (don't persist suggestions).
  </action>
  <verify>
    TypeScript compiles: `cd apps/web && npx tsc --noEmit`
    Build succeeds: `cd apps/web && npm run build`

    Verify SuggestionChips is imported and rendered:
    `grep -n "SuggestionChips" apps/web/App.tsx`
  </verify>
  <done>
    SuggestionChips renders above input field.
    Tapping chip fills input text.
    Chips fade when user types manually.
    Chips clear on send and reset.
  </done>
</task>

</tasks>

<verification>
1. Widget builds successfully
2. SuggestionChips component exists and is used in App.tsx
3. Chips appear above input field (visual verification needed)
4. Tapping chip fills input without auto-submitting
5. Chips have 44px minimum tap target
6. Chips fade when user types in input
</verification>

<success_criteria>
- User sees contextual chips above input after bot message
- Tapping chip fills input field (user can edit before sending)
- Chips are touch-friendly (44x44px minimum)
- Chips fade but remain accessible when typing
- Single chip selection (tapping another replaces text)
- Chips clear after send, new chips appear with next response
</success_criteria>

<output>
After completion, create `.planning/phases/09-suggested-response-chips/09-02-SUMMARY.md`
</output>
