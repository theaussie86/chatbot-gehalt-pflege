---
phase: 09-suggested-response-chips
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/lib/suggestions.ts
  - apps/api/app/api/chat/route.ts
  - apps/api/types/form.ts
autonomous: true

must_haves:
  truths:
    - "API response includes suggestions array with 2-4 contextual chip labels"
    - "Suggestions adapt to current formState.section (job_details, tax_details, summary)"
    - "Suggestions are skipped when current question expects freeform input"
    - "Known field options (Steuerklasse 1-6, TVöD/TV-L/AVR, Stufe 1-6) appear at appropriate stages"
  artifacts:
    - path: "apps/api/lib/suggestions.ts"
      provides: "SuggestionService class with stage-aware chip generation"
      exports: ["SuggestionService", "generateSuggestions"]
    - path: "apps/api/app/api/chat/route.ts"
      provides: "suggestions field in API response"
      contains: "suggestions:"
  key_links:
    - from: "apps/api/app/api/chat/route.ts"
      to: "apps/api/lib/suggestions.ts"
      via: "import and call generateSuggestions"
      pattern: "generateSuggestions\\("
---

<objective>
Create server-side suggestion generation that produces 2-4 contextual quick reply chips based on the current conversation state.

Purpose: Reduce typing friction for users by providing clickable options for common responses.
Output: API chat endpoint returns `suggestions: string[]` alongside existing `text` and `formState` fields.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-suggested-response-chips/09-CONTEXT.md

# Key existing files
@apps/api/app/api/chat/route.ts
@apps/api/lib/salary-flow.ts
@apps/api/types/form.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SuggestionService with stage-aware chip generation</name>
  <files>apps/api/lib/suggestions.ts, apps/api/types/form.ts</files>
  <action>
    Create `apps/api/lib/suggestions.ts` with a `SuggestionService` class and `generateSuggestions` function.

    **SuggestionService logic:**

    1. **Input**: `formState: FormState`, `lastBotMessage: string` (optional, for context)
    2. **Output**: `string[]` with 0-4 short chip labels

    **Stage-specific rules (from CONTEXT.md decisions):**

    ```typescript
    // Predefined chip maps by field being asked
    const PREDEFINED_CHIPS: Record<string, string[]> = {
      // job_details stage
      tarif: ['TVöD', 'TV-L', 'AVR'],
      experience: ['Stufe 1', 'Stufe 2', 'Stufe 3', 'Stufe 4', 'Stufe 5', 'Stufe 6'],
      hours: ['Vollzeit', 'Teilzeit'],
      state: ['NRW', 'Bayern', 'Baden-Württemberg', 'Hessen'],

      // tax_details stage
      taxClass: ['1', '2', '3', '4', '5', '6'],
      churchTax: ['Ja', 'Nein'],
      numberOfChildren: ['0', '1', '2', '3+'],

      // summary stage (confirmation)
      _summary_confirm: ['Ja, berechnen', 'Etwas ändern'],
    };

    // Fields that expect freeform input (skip chips)
    const FREEFORM_FIELDS = ['group']; // e.g., job title requires typing
    ```

    **Function signature:**
    ```typescript
    export function generateSuggestions(
      formState: FormState,
      lastBotMessage?: string
    ): string[] {
      // 1. If section is 'completed', return empty array
      // 2. If section is 'summary', return summary confirmation chips
      // 3. Get first missing field from formState.missingFields
      // 4. If missing field is in FREEFORM_FIELDS, return empty array
      // 5. If missing field has predefined chips, return those (max 4)
      // 6. Otherwise return empty array
    }
    ```

    **Add SuggestionResponse type to form.ts:**
    ```typescript
    export interface ChatResponse {
      text: string;
      formState?: FormState;
      inquiryId?: string;
      suggestions?: string[]; // NEW: Quick reply chip labels
    }
    ```

    Keep chip labels SHORT (one word or short phrase, not full sentences).
    Use German labels matching the expected user input.
  </action>
  <verify>
    TypeScript compiles: `cd apps/api && npx tsc --noEmit`

    Verify exports: `grep -n "export" apps/api/lib/suggestions.ts`
  </verify>
  <done>
    SuggestionService exists with generateSuggestions function that returns appropriate chips for each stage.
    ChatResponse type includes optional suggestions field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate suggestion generation into chat API response</name>
  <files>apps/api/app/api/chat/route.ts</files>
  <action>
    Update the chat route to call `generateSuggestions` and include the result in all API responses.

    **Import at top of file:**
    ```typescript
    import { generateSuggestions } from "../../../lib/suggestions";
    ```

    **Add suggestions to each NextResponse.json call:**

    Find all `return NextResponse.json({` calls in the state machine section and add suggestions field.

    Example pattern for each return:
    ```typescript
    return NextResponse.json({
      text: responseText,
      formState: nextFormState,
      suggestions: generateSuggestions(nextFormState, responseText) // ADD THIS
    });
    ```

    **Specific locations to update (search for `NextResponse.json`):**
    1. Completed state handler (~line 195)
    2. Question intent handler (~line 278)
    3. Summary confirmation handler (~line 394)
    4. Modification handler (~line 481)
    5. Validation error handler (~line 606)
    6. Summary state display (~line 627)
    7. Main response generation (~line 656)

    **For the non-state-machine path (legacy agent path ~line 697):**
    Do NOT add suggestions - legacy path doesn't use formState.

    **Important:** Pass the response text to generateSuggestions so it can potentially use context from the bot's message for smarter suggestions (future enhancement).
  </action>
  <verify>
    TypeScript compiles: `cd apps/api && npx tsc --noEmit`

    Count suggestions in responses: `grep -c "suggestions:" apps/api/app/api/chat/route.ts` should be >= 6
  </verify>
  <done>
    All state machine response paths include suggestions field.
    Suggestions are generated based on current formState stage.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for API app
2. suggestions.ts exports generateSuggestions function
3. All state machine response paths include suggestions field
4. Chip arrays are appropriate for each stage (verify with unit test or manual inspection)
</verification>

<success_criteria>
- API chat endpoint returns suggestions array in response
- Suggestions are contextually appropriate (tariff options in job_details, Steuerklasse in tax_details, etc.)
- Summary stage returns confirmation chips ["Ja, berechnen", "Etwas ändern"]
- Completed stage returns empty suggestions array
- Freeform input fields return empty suggestions array
</success_criteria>

<output>
After completion, create `.planning/phases/09-suggested-response-chips/09-01-SUMMARY.md`
</output>
